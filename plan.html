<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü–ª–∞–Ω –ø–æ–≤–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è</title>
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üé¨</text></svg>">
    <script src="theme-loader.js"></script>
    <link rel="stylesheet" href="theme.css">
    <link rel="stylesheet" href="auth-widget.css">
    <script src="gdrive-service.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <style>
        :root {
            --primary-color: #2563eb;
            --bg-color: #F2F2F7;
            --card-bg: #ffffff;
            --text-color: #1e293b;
            --border-color: #e2e8f0;
            --sidebar-width: 280px;
            --thesis-accent: #cbd5e1;
        }

        /* Sidebar Styles (Keeping these) */
        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 0;
            display: flex;
            height: 100vh;
            overflow: hidden;
            line-height: 1.5;
        }

        .app-root {
            display: flex;
            width: 100%;
            height: 100%;
            box-sizing: border-box;
        }

        .sidebar {
            width: var(--sidebar-width);
            background: #ffffff;
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            padding: 0;
            flex-shrink: 0;
            overflow: hidden;
            z-index: 100;
        }

        .sidebar-scrollable {
            flex-grow: 1;
            padding: 20px 16px;
            overflow-y: auto;
        }

        .sidebar-user {
            padding: 16px;
            border-top: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: background 0.2s;
            background: #fff;
        }

        .sidebar-user:hover {
            background: #f8fafc;
        }

        .sidebar-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            object-fit: cover;
            background: #f1f5f9;
        }

        .sidebar-user-info-text {
            flex-grow: 1;
            min-width: 0;
        }

        .sidebar-user-name {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-color);
            margin: 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .sidebar-user-email {
            font-size: 0.75rem;
            color: #64748b;
            margin: 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .sidebar-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 4px;
            margin-bottom: 24px;
            border-radius: 8px;
            transition: background 0.2s;
        }

        button {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            color: white;
            background-color: var(--primary-color);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.2s;
        }

        button svg {
            width: 18px;
            height: 18px;
        }

        .sidebar-header-left {
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 700;
            font-size: 1.05rem;
            color: #1e293b;
        }

        .sidebar-icon-box {
            background: #f1f5f9;
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #64748b;
        }

        .btn-create-new {
            background: #8b3dff;
            color: #ffffff;
            border: none;
            padding: 12px 16px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-bottom: 28px;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            width: 100%;
            box-shadow: 0 4px 12px rgba(139, 61, 255, 0.2);
        }

        .btn-create-new:hover {
            background: #7a2de0;
            transform: translateY(-1px);
        }

        .sidebar-divider {
            height: 1px;
            background: #f1f5f9;
            margin: 15px 8px;
        }

        .sidebar-label {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: #94a3b8;
            font-weight: 800;
            margin-bottom: 12px;
            padding-left: 8px;
        }

        .sidebar-nav-item {
            display: flex;
            align-items: center;
            justify-content: flex-start;
            gap: 12px;
            padding: 10px 12px;
            border-radius: 10px;
            color: #475569;
            text-decoration: none;
            font-size: 0.95rem;
            font-weight: 500;
            margin-bottom: 4px;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
        }

        .sidebar-nav-item:hover {
            background: #f1f5f9;
            color: #1e293b;
        }

        .sidebar-nav-item.active {
            background: #f1f5f9;
            color: var(--primary-color);
            font-weight: 600;
        }

        .sidebar-nav-item svg {
            width: 20px;
            height: 20px;
            color: #94a3b8;
            flex-shrink: 0;
        }

        .sidebar-file-wrapper {
            position: relative;
            margin-bottom: 4px;
        }

        .sidebar-file-wrapper:hover .item-menu-dots {
            opacity: 1;
        }

        .item-menu-dots {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: #94a3b8;
            cursor: pointer;
            padding: 2px 8px;
            border-radius: 6px;
            opacity: 0;
            transition: opacity 0.2s, background 0.2s;
            z-index: 10;
            font-size: 1.2rem;
            line-height: 1;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .item-menu-dots:hover {
            background: #e2e8f0;
            color: var(--text-color);
        }

        .sidebar-file-menu {
            display: none;
            position: absolute;
            right: 10px;
            top: 100%;
            background-color: white;
            min-width: 140px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            overflow: hidden;
        }

        .sidebar-file-menu.show {
            display: block;
        }

        .sidebar-file-menu button {
            padding: 10px 16px;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 8px;
            width: 100%;
            text-align: left;
            background: none;
            font-size: 0.85rem;
            font-weight: 500;
            border: none;
            border-radius: 0;
            color: var(--text-color);
            transition: background 0.2s;
        }

        .sidebar-file-menu button:hover {
            background-color: #f8fafc;
        }

        .btn-menu-delete {
            color: #ef4444 !important;
        }

        .btn-menu-delete:hover {
            background-color: #fef2f2 !important;
        }

        .btn-sidebar-action {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px;
            width: 100%;
            background: #fff;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            font-weight: 600;
            font-size: 0.85rem;
            color: #475569;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 8px;
        }

        .btn-sidebar-action:hover {
            background: #f8fafc;
        }

        .btn-sidebar-action.primary {
            background: #4285f4;
            color: #fff;
            border: none;
        }

        .main-content {
            flex-grow: 1;
            background: var(--bg-color);
            overflow-y: auto;
            padding: 32px 24px;
            scroll-behavior: smooth;
        }

        .main-container-limited {
            width: 100%;
            max-width: 900px;
            margin: 0 auto;
            /* Explicitly center */
            padding-bottom: 50px;
        }

        .btn-load {
            background-color: #10b948;
            color: white;
        }

        .btn-add-thesis {
            width: 100%;
            max-width: 400px;
            padding: 12px 20px;
            font-size: 1rem;
        }

        /* User's Original Styles (Returned) */
        .section {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 24px;
            margin-bottom: 15px;
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 12px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: flex;
            align-items: center;
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 0.95rem;
        }

        .info-icon {
            margin-left: 8px;
            width: 18px;
            height: 18px;
            background: #e0e7ff;
            color: var(--primary-color);
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            cursor: help;
            position: relative;
        }

        .info-icon:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 130%;
            left: 50%;
            transform: translateX(-50%);
            width: 280px;
            background: #334155;
            color: white;
            padding: 10px;
            border-radius: 6px;
            font-size: 0.85rem;
            z-index: 10000;
            /* Extremely high to prevent overlap by header */
            white-space: normal;
            line-height: 1.4;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        /* Tooltip position fix for items near top */
        .info-icon.bottom:hover::after {
            bottom: auto;
            top: 130%;
        }

        .toggle-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            padding: 10px 16px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .toggle-container:hover {
            background: #f8fafc;
        }

        .toggle-label {
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--text-color);
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 44px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #e2e8f0;
            transition: .3s;
            border-radius: 24px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .3s;
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        input:checked+.slider {
            background-color: #34c759;
        }

        input:checked+.slider:before {
            transform: translateX(20px);
        }

        .comment-group,
        .transition-group {
            display: none;
        }

        .comment-group.visible,
        .transition-group.visible {
            display: block;
        }

        .transition-textarea {
            min-height: 1.5em !important;
        }

        .grid-info.wide {
            grid-template-columns: 1fr;
        }

        .grid-info.with-comment {
            grid-template-columns: 2.5fr 1fr;
        }

        input,
        select,
        .rich-textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 1rem;
            font-family: inherit;
            box-sizing: border-box;
            background: #fff;
        }

        select {
            appearance: none;
            -webkit-appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='none' stroke='%234b5563' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='m3 4.5 3 3 3-3'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 10px center;
            padding-right: 30px;
            cursor: pointer;
        }

        .rich-textarea {
            min-height: 80px;
            cursor: text;
            white-space: pre-wrap;
            overflow-wrap: anywhere;
            transition: all 0.2s;
            line-height: 1.5;
            max-width: 100%;
            width: 100%;
        }

        .rich-textarea:empty:before {
            content: attr(placeholder);
            color: #94a3b8;
            pointer-events: none;
            display: block;
        }

        input:focus,
        select:focus,
        .rich-textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        /* NEW EDITING STYLES: Fixed alignment */
        .rich-textarea,
        .thesis-name-input {
            border: 1px solid transparent;
            background: transparent;
            padding: 10px 0;
            /* No horizontal padding by default */
            transition: all 0.2s;
            border-radius: 6px;
            margin-left: 0;
        }

        .is-editing .rich-textarea,
        .is-editing .thesis-name-input {
            border-color: var(--border-color);
            background: #fff;
            padding: 10px 12px;
            margin-left: -8px;
            /* Slightly reduced pull to keep distance from accent */
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .is-editing .rich-textarea:focus,
        .is-editing .thesis-name-input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        body.dark .is-editing .rich-textarea,
        body.dark .is-editing .thesis-name-input {
            background: #0f172a;
            border-color: #334155;
        }

        .btn-edit-toggle {
            background: #f1f5f9;
            color: #64748b;
            padding: 6px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            border: 1px solid transparent;
        }

        .btn-edit-toggle:hover {
            background: #e2e8f0;
            color: var(--primary-color);
        }

        .is-editing .btn-edit-toggle {
            background: #dcfce7;
            color: #166534;
        }

        .is-editing .btn-edit-toggle:hover {
            background: #bbf7d0;
        }

        .section:not(.is-editing) select,
        .thesis-block:not(.is-editing) select {
            pointer-events: none;
            border-color: transparent;
            background-image: none;
            padding-right: 10px;
            cursor: default;
        }

        select.filled {
            background-color: #dcfce7;
            color: #166534;
            border-color: #bbf7d0;
            font-weight: 600;
        }

        body.dark select.filled {
            background-color: rgba(16, 185, 129, 0.2);
            color: #34d399;
            border-color: rgba(16, 185, 129, 0.3);
        }

        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .grid-info {
            display: grid;
            grid-template-columns: 2.5fr 1fr;
            gap: 20px;
        }

        .section-divider {
            border: none;
            height: 1px;
            background: linear-gradient(to right, transparent, #bdbdbda1, transparent);
            margin: 20px auto;
            width: 100%;
        }

        .thesis-block {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 24px;
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            position: relative;
            overflow: hidden;
        }

        .thesis-block::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 8px;
            background-color: var(--thesis-accent);
            z-index: 0;
        }

        .thesis-block .thesis-header,
        .thesis-block .grid-info {
            position: relative;
            z-index: 1;
        }

        .thesis-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .thesis-title {
            display: none;
        }

        .thesis-name-input {
            padding: 10px 0;
            border: 1px solid transparent;
            border-radius: 6px;
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-color);
            background: transparent;
            width: auto;
            min-width: 100px;
            max-width: none;
            transition: all 0.2s;
            min-height: 1.4em;
            line-height: 1.4;
            word-wrap: break-word;
            display: inline-block;
            vertical-align: middle;
            margin-left: 0;
        }

        .is-editing .thesis-name-input {
            padding: 10px 12px;
            margin-left: -12px;
        }

        .thesis-name-input:empty:before {
            content: attr(placeholder);
            color: #94a3b8;
            pointer-events: none;
        }

        /* REMOVED OLD SELECTION STATES */


        .menu-container {
            position: relative;
            display: inline-block;
        }

        .menu-dots {
            background: none;
            color: #94a3b8;
            padding: 5px 10px;
            font-size: 1.2rem;
            cursor: pointer;
            border: none;
            height: auto;
            width: auto;
        }

        .menu-dots:hover {
            color: var(--text-color);
            background: #f1f5f9;
        }

        .upload-icon-btn:hover {
            transform: scale(1.1);
            background: #fff;
        }

        .upload-icon-btn svg {
            width: 20px;
            height: 20px;
        }

        .menu-content {
            display: none;
            position: absolute;
            right: 0;
            top: 100%;
            background-color: white;
            min-width: 150px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.15);
            z-index: 100;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            margin-top: 5px;
            overflow: hidden;
        }

        .menu-content.show {
            display: block;
        }

        .menu-content button {
            color: #ef4444;
            padding: 12px 16px;
            text-decoration: none;
            display: block;
            width: 100%;
            text-align: left;
            background: none;
            font-size: 0.9rem;
            font-weight: 500;
            border: none;
            border-radius: 0;
        }

        .menu-content button:hover {
            background-color: #fef2f2;
        }

        .menu-content .menu-item {
            border-bottom: 1px solid var(--border-color);
        }

        .btn-delete {
            color: #ef4444 !important;
        }

        .drag-handle {
            cursor: grab;
            color: #94a3b8;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .is-editing .drag-handle {
            margin-right: 4px;
        }

        .is-editing .thesis-name-input {
            margin-left: -8px !important;
            /* Slightly less negative margin to give room to the handle */
        }

        .drag-handle:hover {
            color: #64748b;
        }

        .drag-handle:active {
            cursor: grabbing;
        }

        .sortable-ghost {
            opacity: 0.4;
            background: #f1f5f9;
        }

        #toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 2000;
        }

        .toast {
            background: #334155;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            margin-top: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: center;
            gap: 10px;
            animation: slideIn 0.3s ease-out;
        }

        .toast.success {
            background: #10b981;
        }

        .toast.error {
            background: #ef4444;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.4);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 3000;
            backdrop-filter: blur(2px);
        }

        .modal {
            background: white;
            padding: 24px;
            border-radius: 12px;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.15);
        }

        .modal h3 {
            margin-top: 0;
        }

        .modal-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            margin-top: 24px;
        }

        .btn-secondary {
            background: #f1f5f9;
            color: #64748b;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .modal input {
            margin-top: 15px;
        }

        .cover-container {
            width: 400px;
            aspect-ratio: 16 / 9;
            background: #f1f5f9;
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .cover-preview {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

        .upload-overlay {
            position: absolute;
            top: 10px;
            right: 10px;
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .cover-container:hover .upload-overlay {
            opacity: 1;
        }

        .upload-icon-btn {
            background: rgba(255, 255, 255, 0.9);
            color: var(--primary-color);
            width: 36px;
            height: 36px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            transition: all 0.2s;
            border: none;
        }

        .loader {
            width: 24px;
            height: 24px;
            border: 3px solid #FFF;
            border-bottom-color: transparent;
            border-radius: 50%;
            display: none;
            box-sizing: border-box;
            animation: rotation 1s linear infinite;
        }

        @keyframes rotation {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Dark Mode Support (Basic) */
        body.dark {
            --bg-color: #0f172a;
            --card-bg: #1e293b;
            --text-color: #f1f5f9;
            --border-color: #334155;
            --thesis-accent: #475569;
        }

        body.dark .sidebar {
            background: #1e293b;
        }

        body.dark .sidebar-header-left {
            color: #f1f5f9;
        }

        body.dark .sidebar-nav-item:hover,
        body.dark .sidebar-nav-item.active {
            background: #334155;
            color: #fff;
        }

        body.dark input,
        body.dark select,
        body.dark .rich-textarea,
        body.dark .thesis-name-input {
            background: #0f172a;
            color: #f1f5f9;
            border-color: #334155;
        }

        body.dark .modal {
            background: #1e293b;
            color: #f1f5f9;
        }

        body.dark .sidebar-user {
            background: #1e293b;
            border-top-color: #334155;
        }

        body.dark .sidebar-user:hover {
            background: #334155;
        }

        body.dark .sidebar-user-name {
            color: #f1f5f9;
        }

        body.dark .sidebar-user-email {
            color: #94a3b8;
        }

        /* –ê–Ω–∏–º–∞—Ü–∏—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞ */
        #planForm {
            transition: opacity 0.25s ease-in-out, transform 0.25s ease-in-out;
            opacity: 1;
            transform: translateY(0);
        }

        #planForm.content-fade {
            opacity: 0;
            transform: translateY(10px);
        }

        /* Welcome Screen */
        .welcome-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 60vh;
            text-align: center;
            padding: 20px;
            animation: fadeIn 0.5s ease-out;
        }

        .welcome-screen-illustration {
            width: 180px;
            height: auto;
            margin-bottom: 0px;
            opacity: 0.9;
            user-select: none;
            -webkit-user-drag: none;
        }

        .welcome-screen h2 {
            font-size: 1.4rem;
            color: #1e293b;
            margin: 0 0 8px 0;
            font-weight: 700;
        }

        .welcome-screen p {
            color: #64748b;
            font-size: 0.9rem;
            max-width: 340px;
            line-height: 1.5;
            margin-top: 0px;
            margin-bottom: 24px;
        }

        .welcome-actions {
            display: flex;
            gap: 12px;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        body.dark .welcome-screen h2 {
            color: #f1f5f9;
        }

        body.dark .welcome-screen p {
            color: #94a3b8;
        }

        .sync-status {
            font-size: 13px;
            color: #64748b;
            display: flex;
            align-items: center;
            gap: 6px;
            margin: -16px 0 20px 8px;
            /* –û—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–π –º–∞—Ä–∂–∏–Ω –≤–≤–µ—Ä—Ö —á—Ç–æ–±—ã –±—ã—Ç—å –±–ª–∏–∂–µ –∫ —à–∞–ø–∫–µ */
            font-weight: 500;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
        }

        .sync-status svg {
            width: 18px;
            height: 18px;
            color: #64748b;
        }
    </style>
</head>

<body>

    <div class="app-root">
        <aside class="sidebar">
            <div class="sidebar-scrollable">
                <div class="sidebar-header">
                    <div class="sidebar-header-left">
                        <div class="sidebar-icon-box">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2.5">
                                <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z">
                                </path>
                            </svg>
                        </div>
                        <span>–ü–ª–∞–Ω –ø–æ–≤–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è</span>
                    </div>
                </div>
                <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ -->
                <div id="syncStatus" class="sync-status"></div>

                <button class="btn-create-new" onclick="createNewPlan()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"
                        stroke-linecap="round" stroke-linejoin="round">
                        <line x1="12" y1="5" x2="12" y2="19"></line>
                        <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                    –°–æ–∑–¥–∞—Ç—å –ø–ª–∞–Ω
                </button>

                <div class="sidebar-divider"></div>

                <div class="sidebar-label">–ú–æ–∏ —Ñ–∞–π–ª—ã</div>
                <div id="sidebar-file-list" style="margin-bottom: 12px;">
                    <div style="padding: 20px; color: #94a3b8; font-size: 0.85rem; text-align: center;">
                        –í–æ–π–¥–∏—Ç–µ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
                    </div>
                </div>
            </div>

            <div id="sidebar-action-container"
                style="display: none; padding: 12px 16px; border-top: 1px solid var(--border-color);">
                <button type="button" class="btn-load btn-add-thesis" onclick="addThesis()"
                    style="width: 100%; padding: 10px; font-size: 0.9rem; border-radius: 10px; box-shadow: 0 2px 8px rgba(16, 185, 129, 0.2);">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round"
                        stroke-linejoin="round" style="width: 16px; height: 16px;">
                        <line x1="12" y1="5" x2="12" y2="19"></line>
                        <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                    –î–æ–±–∞–≤–∏—Ç—å –±–ª–æ–∫
                </button>
            </div>

            <div class="sidebar-user" id="sidebar-user-trigger" onclick="window.openAuthModal(this)"
                style="border-top: 1px solid var(--border-color);">
                <img id="sidebar-user-avatar" class="sidebar-avatar" src="https://via.placeholder.com/36">
                <div class="sidebar-user-info-text">
                    <p class="sidebar-user-name" id="sidebar-user-name">–ì–æ—Å—Ç—å</p>
                    <p class="sidebar-user-email" id="sidebar-user-email">–í–æ–π—Ç–∏ –≤ –∞–∫–∫–∞—É–Ω—Ç</p>
                </div>
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#94a3b8" stroke-width="2"
                    stroke-linecap="round" stroke-linejoin="round">
                    <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                    <polyline points="16 17 21 12 16 7"></polyline>
                    <line x1="21" y1="12" x2="9" y2="12"></line>
                </svg>
            </div>
        </aside>

        <main class="main-content">
            <div class="main-container-limited">
                <!-- Welcome Screen -->
                <div id="welcomeScreen" class="welcome-screen">
                    <img src="https://todoist.b-cdn.net/assets/images/f6defa2ca953237a.png"
                        class="welcome-screen-illustration" alt="Welcome" draggable="false">
                    <h2>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!</h2>
                    <p>–í—ã–±–µ—Ä–∏—Ç–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –ø–ª–∞–Ω –∏–∑ –±–æ–∫–æ–≤–æ–≥–æ –º–µ–Ω—é —Å–ª–µ–≤–∞ –∏–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å —Ä–∞–±–æ—Ç—É.</p>
                </div>

                <form id="planForm" style="display: none;">
                    <div class="section" id="section_main">
                        <div class="thesis-header">
                            <div
                                style="font-weight: 600; font-size: 1.3rem; display: flex; align-items: center; color: var(--text-color);">
                                –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
                            </div>
                            <button type="button" class="btn-edit-toggle"
                                onclick="toggleSectionEdit('section_main', this)" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                    <path d="M18.5 2.5a2.121 2.121 0 1 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                </svg>
                            </button>
                        </div>
                        <!-- –û–±–ª–æ–∂–∫–∞ —Å–≤–µ—Ä—Ö—É -->
                        <div class="form-group"
                            style="display: flex; flex-direction: column; align-items: center; margin-bottom: 30px;">
                            <label style="margin-bottom: 10px;">–û–±–ª–æ–∂–∫–∞
                                <span class="info-icon bottom"
                                    data-tooltip="–í —ç—Ç–æ–º –±–ª–æ–∫–µ —Ä–∞–∑–º–µ—â–µ–Ω —ç—Å–∫–∏–∑ –ø—Ä–µ–≤—å—é, —á—Ç–æ–±—ã –±—ã–ª–æ –Ω–∞–≥–ª—è–¥–Ω–æ —è—Å–Ω–æ, –∫–∞–∫ –º–æ–∂–µ—Ç –≤—ã–≥–ª—è–¥–µ—Ç—å –æ–±–ª–æ–∂–∫–∞.">?</span>
                            </label>
                            <div class="cover-container" id="coverContainer" style="margin: 0 auto;">
                                <img id="coverPreview"
                                    src="https://placehold.co/800x450?text=%D0%97%D0%B0%D0%B3%D1%80%D1%83%D0%B7%D0%B8%D1%82%D0%B5+%D0%9F%D1%80%D0%B5%D0%B2%D1%8C%D1%8E"
                                    class="cover-preview" draggable="false">
                                <div class="upload-overlay">
                                    <input type="file" id="coverInput" accept="image/*" style="display: none"
                                        onchange="uploadImage(this)">
                                    <button type="button" class="upload-icon-btn"
                                        onclick="document.getElementById('coverInput').click()" id="uploadBtn"
                                        title="–ó–∞–≥—Ä—É–∑–∏—Ç—å –æ–±–ª–æ–∂–∫—É">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M17 8l-5-5-5 5M12 3v12">
                                            </path>
                                        </svg>
                                    </button>
                                    <span class="loader" id="uploadLoader" style="display: none;"></span>
                                </div>
                                <input type="hidden" id="coverUrl">
                            </div>
                        </div>

                        <!-- –ù–∞–∑–≤–∞–Ω–∏–µ –∏ –•—Ä–æ–Ω–æ–º–µ—Ç—Ä–∞–∂ -->
                        <div class="grid-info" style="align-items: flex-start; margin-bottom: 25px;">
                            <div class="form-group" style="margin-bottom: 0;">
                                <label>–ù–∞–∑–≤–∞–Ω–∏–µ
                                    <span class="info-icon"
                                        data-tooltip="–£–∫–∞–∑—ã–≤–∞–µ–º –æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–æ—á–Ω—ã–π/—Ñ–∏–Ω–∞–ª—å–Ω—ã–π –∑–∞–≥–æ–ª–æ–≤–æ–∫. –ö–∞–∫ –±—É–¥–µ—Ç –Ω–∞–∑—ã–≤–∞—Ç—å—Å—è –≤–∏–¥–µ–æ?">?</span>
                                </label>
                                <div id="title" class="thesis-name-input" contenteditable="false"
                                    placeholder="–ö–∞–∫ –±—É–¥–µ—Ç –Ω–∞–∑—ã–≤–∞—Ç—å—Å—è –≤–∏–¥–µ–æ?"></div>
                            </div>

                            <div class="form-group" style="margin-bottom: 0;">
                                <label>–•—Ä–æ–Ω–æ–º–µ—Ç—Ä–∞–∂ –≤–∏–¥–µ–æ
                                    <span class="info-icon"
                                        data-tooltip="–ò—Ç–æ–≥–æ–≤–∞—è –¥–ª–∏–Ω–∞ —Ä–æ–ª–∏–∫–∞, –æ—Å–Ω–æ–≤—ã–≤–∞–Ω–Ω–∞—è –∏—Å—Ö–æ–¥—è –∏–∑ —Å—Ä–µ–¥–Ω–µ–≥–æ —Ö—Ä–æ–Ω–æ–º–µ—Ç—Ä–∞–∂–∞ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤ –≤ –Ω–∏—à–µ.">?</span>
                                </label>
                                <select id="duration" style="width: 100%;" onchange="handleCustomSelect(this)">
                                    <option value="" disabled selected>–í—ã–±–µ—Ä–∏—Ç–µ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å</option>
                                    <option value="8 - 10 –º–∏–Ω—É—Ç">8 - 10 –º–∏–Ω—É—Ç</option>
                                    <option value="10 - 12 –º–∏–Ω—É—Ç">10 - 12 –º–∏–Ω—É—Ç</option>
                                    <option value="12 - 14 –º–∏–Ω—É—Ç">12 - 14 –º–∏–Ω—É—Ç</option>
                                    <option value="14 - 16 –º–∏–Ω—É—Ç">14 - 16 –º–∏–Ω—É—Ç</option>
                                    <option value="16+ –º–∏–Ω—É—Ç">16+ –º–∏–Ω—É—Ç</option>
                                    <option value="custom">–°–≤–æ–π –≤–∞—Ä–∏–∞–Ω—Ç...</option>
                                </select>
                            </div>
                        </div>

                        <!-- –¢–ó –∏ –û –≤–∏–¥–µ–æ -->
                        <div class="grid-2">
                            <div class="form-group" style="margin-bottom: 0;">
                                <label>–¢–∑ –¥–ª—è –ø—Ä–µ–≤—å—é
                                    <span class="info-icon"
                                        data-tooltip="–û–ø–∏—Å–∞–Ω–∏–µ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –¥–ª—è –ø—Ä–µ–≤—å—é. –ó–¥–µ—Å—å –≤–∞–∂–Ω–æ —É–∫–∞–∑–∞—Ç—å —ç–º–æ—Ü–∏—é –∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è —Ñ–æ—Ç–æ –∞–≤—Ç–æ—Ä–∞.">?</span>
                                </label>
                                <div id="preview" class="rich-textarea" contenteditable="false" placeholder=""></div>
                            </div>

                            <div class="form-group" style="margin-bottom: 0;">
                                <label>–û –≤–∏–¥–µ–æ
                                    <span class="info-icon" data-tooltip="–ö—Ä–∞—Ç–∫–æ –æ–ø–∏—Å—ã–≤–∞–µ–º —Å—É—Ç—å –≤–∏–¥–µ–æ.">?</span>
                                </label>
                                <div id="producer_comment" class="rich-textarea" contenteditable="false" placeholder="">
                                </div>
                            </div>
                        </div>
                    </div>

                    <hr class="section-divider">

                    <div class="section" id="section_intro">
                        <div class="thesis-header">
                            <div style="font-weight: 600; font-size: 1.3rem; display: flex; align-items: center;">
                                –ò–Ω—Ç—Ä–æ
                                <span class="info-icon"
                                    data-tooltip="–ó–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è –≤ —Å–∞–º—É—é –ø–æ—Å–ª–µ–¥–Ω—é—é –æ—á–µ—Ä–µ–¥—å. –ö–æ–≥–¥–∞ –ø–æ–Ω—è—Ç–Ω–æ, –∫–∞–∫–æ–π –±–∞–π—Ç –±—É–¥–µ—Ç –Ω–∞ –ø—Ä–µ–≤—å—é, –∫–∞–∫ –µ–≥–æ —Ä–∞—Å–∫—Ä—ã–≤–∞–µ–º –≤ –≤–∏–¥–µ–æ –∏ –Ω–∞ —á—Ç–æ —Å–¥–µ–ª–∞—Ç—å –∞–∫—Ü–µ–Ω—Ç, —á—Ç–æ–± –∑—Ä–∏—Ç–µ–ª—å –¥–æ—Å–º–æ—Ç—Ä–µ–ª –≤–∏–¥–µ–æ –¥–æ —Å–∞–º–æ–≥–æ –∫–æ–Ω—Ü–∞.">?</span>
                            </div>
                            <div style="display: flex; gap: 8px; align-items: center;">
                                <select id="intro_duration" style="width: 160px;" onchange="handleCustomSelect(this)">
                                    <option value="" disabled selected>–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å</option>
                                    <option value="20 —Å–µ–∫">20 —Å–µ–∫</option>
                                    <option value="30 - 60 —Å–µ–∫">30 - 60 —Å–µ–∫</option>
                                    <option value="60 - 90 —Å–µ–∫">60 - 90 —Å–µ–∫</option>
                                    <option value="2 –º–∏–Ω—É—Ç—ã">2 –º–∏–Ω—É—Ç—ã</option>
                                    <option value="custom">–°–≤–æ–π –≤–∞—Ä–∏–∞–Ω—Ç...</option>
                                </select>
                                <button type="button" class="btn-edit-toggle"
                                    onclick="toggleSectionEdit('section_intro', this)" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                        stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                        <path d="M18.5 2.5a2.121 2.121 0 1 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                    </svg>
                                </button>
                                <div class="menu-container">
                                    <button type="button" class="menu-dots" onclick="toggleMenu('intro')">‚ãÆ</button>
                                    <div id="menu_intro" class="menu-content">
                                        <div class="menu-item">
                                            <label class="toggle-container" onclick="event.stopPropagation()">
                                                <span class="toggle-label">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</span>
                                                <div class="toggle-switch">
                                                    <input type="checkbox" id="toggle_intro"
                                                        onchange="toggleComment('intro', this.checked)">
                                                    <span class="slider"></span>
                                                </div>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="grid-info wide" id="grid_intro">
                            <div class="form-group" style="margin-bottom: 0;">
                                <label>–¢–µ–∫—Å—Ç –∞–≤—Ç–æ—Ä–∞</label>
                                <div id="intro" class="rich-textarea" contenteditable="false"
                                    placeholder="–ü—Ä—è–º–∞—è —Ä–µ—á—å –∞–≤—Ç–æ—Ä–∞. –ß—Ç–æ –Ω—É–∂–Ω–æ —Å–∫–∞–∑–∞—Ç—å, —á—Ç–æ–± –∑—Ä–∏—Ç–µ–ª—å –¥–æ—Å–º–æ—Ç—Ä–µ–ª –≤–∏–¥–µ–æ –¥–æ —Å–∞–º–æ–≥–æ –∫–æ–Ω—Ü–∞?">
                                </div>
                            </div>
                            <div class="form-group comment-group" id="group_intro_comment" style="margin-bottom: 0;">
                                <label>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
                                <div id="intro_comment" class="rich-textarea" contenteditable="false"></div>
                            </div>
                        </div>
                    </div>

                    <hr class="section-divider">

                    <div id="theses-container"></div>

                    <hr class="section-divider">

                    <div class="section" id="section_outro">
                        <div class="thesis-header">
                            <div style="font-weight: 600; font-size: 1.3rem; display: flex; align-items: center;">
                                –ó–∞–∫–ª—é—á–∏—Ç–µ–ª—å–Ω–∞—è —á–∞—Å—Ç—å
                                <span class="info-icon"
                                    data-tooltip="–í –¥–∞–Ω–Ω–æ–º –±–ª–æ–∫–µ –∂–µ–ª–∞—Ç–µ–ª—å–Ω–æ –ù–ï —Ä–∞–∑–º–∞–∑—ã–≤–∞—Ç—å –∫–æ–Ω—Ü–æ–≤–∫—É. –ú–æ–∂–Ω–æ –±—ã—Å—Ç—Ä–æ –ø—Ä–∏–∑–≤–∞—Ç—å –ø–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –∏ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –¥—Ä—É–≥–∏–µ —Ä–æ–ª–∏–∫–∏ –Ω–∞ –∫–∞–Ω–∞–ª–µ.">?</span>
                            </div>
                            <div style="display: flex; gap: 8px; align-items: center;">
                                <select id="outro_duration" style="width: 160px;" onchange="handleCustomSelect(this)">
                                    <option value="" disabled selected>–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å</option>
                                    <option value="20 —Å–µ–∫">20 —Å–µ–∫</option>
                                    <option value="30 - 60 —Å–µ–∫">30 - 60 —Å–µ–∫</option>
                                    <option value="60 - 90 —Å–µ–∫">60 - 90 —Å–µ–∫</option>
                                    <option value="2 –º–∏–Ω—É—Ç—ã">2 –º–∏–Ω—É—Ç—ã</option>
                                    <option value="custom">–°–≤–æ–π –≤–∞—Ä–∏–∞–Ω—Ç...</option>
                                </select>
                                <button type="button" class="btn-edit-toggle"
                                    onclick="toggleSectionEdit('section_outro', this)" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                        stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                        <path d="M18.5 2.5a2.121 2.121 0 1 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                    </svg>
                                </button>
                                <div class="menu-container">
                                    <button type="button" class="menu-dots" onclick="toggleMenu('outro')">‚ãÆ</button>
                                    <div id="menu_outro" class="menu-content">
                                        <div class="menu-item">
                                            <label class="toggle-container" onclick="event.stopPropagation()">
                                                <span class="toggle-label">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</span>
                                                <div class="toggle-switch">
                                                    <input type="checkbox" id="toggle_outro"
                                                        onchange="toggleComment('outro', this.checked)">
                                                    <span class="slider"></span>
                                                </div>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="grid-info wide" id="grid_outro">
                            <div class="form-group" style="margin-bottom: 0;">
                                <label>–¢–µ–∫—Å—Ç –∞–≤—Ç–æ—Ä–∞</label>
                                <div id="outro" class="rich-textarea" contenteditable="false" placeholder=""></div>
                            </div>

                            <div class="form-group comment-group" id="group_outro_comment" style="margin-bottom: 0;">
                                <label>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
                                <div id="outro_comment" class="rich-textarea" contenteditable="false" placeholder="">
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </main>
    </div>

    <div id="toast-container"></div>

    <div id="confirmModal" class="modal-overlay">
        <div class="modal">
            <h3 id="modalTitle">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ</h3>
            <p id="modalText"></p>
            <div class="modal-buttons">
                <button class="btn-secondary" onclick="closeModal('confirmModal')">–û—Ç–º–µ–Ω–∞</button>
                <button id="confirmBtn" class="btn-danger">–£–¥–∞–ª–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <div id="promptModal" class="modal-overlay">
        <div class="modal">
            <h3 id="promptTitle">–°–≤–æ–π –≤–∞—Ä–∏–∞–Ω—Ç</h3>
            <p id="promptText">–í–≤–µ–¥–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏–µ:</p>
            <input type="text" id="promptInput" placeholder="–í–≤–µ–¥–∏—Ç–µ...">
            <div class="modal-buttons">
                <button class="btn-secondary" onclick="closeModal('promptModal')">–û—Ç–º–µ–Ω–∞</button>
                <button id="promptBtn" class="btn-primary"
                    style="color: white; padding: 10px 20px; border-radius: 6px; font-weight: 600;">–ì–æ—Ç–æ–≤–æ</button>
            </div>
        </div>
    </div>

    <script>
        // Utilities
        function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            container.appendChild(toast);
            setTimeout(() => { toast.style.opacity = '0'; setTimeout(() => toast.remove(), 300); }, 3000);
        }

        const openModal = id => document.getElementById(id).style.display = 'flex';
        const closeModal = id => document.getElementById(id).style.display = 'none';

        function handleCustomSelect(select) {
            updateSelectStyle(select);
            if (select.value === 'custom') {
                const input = document.getElementById('promptInput');
                input.value = '';
                document.getElementById('promptTitle').textContent = '–°–≤–æ–π –≤–∞—Ä–∏–∞–Ω—Ç';
                document.getElementById('promptText').textContent = '–í–≤–µ–¥–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏–µ:';
                openModal('promptModal');
                document.getElementById('promptBtn').onclick = () => {
                    const val = input.value.trim();
                    if (val) {
                        const opt = document.createElement('option');
                        opt.value = val; opt.text = val; opt.selected = true;
                        select.add(opt, select.options[select.options.length - 1]);
                        closeModal('promptModal');
                        updateSelectStyle(select);
                    }
                };
            }
        }

        function updateSelectStyle(select) {
            if (select.value && select.value !== "" && select.value !== "custom") select.classList.add('filled');
            else select.classList.remove('filled');
        }

        function toggleMenu(id) {
            document.querySelectorAll('.menu-content').forEach(m => { if (m.id !== `menu_${id}`) m.classList.remove('show'); });
            const menu = document.getElementById(`menu_${id}`);
            if (menu) menu.classList.toggle("show");
        }

        function toggleComment(sectionId, isVisible) {
            const group = document.getElementById(`group_${sectionId}_comment`);
            const grid = document.getElementById(`grid_${sectionId}`);
            if (isVisible) { group.classList.add('visible'); grid.classList.remove('wide'); grid.classList.add('with-comment'); }
            else { group.classList.remove('visible'); grid.classList.add('wide'); grid.classList.remove('with-comment'); }
        }

        function toggleTransition(sectionId, isVisible) {
            const group = document.getElementById(`group_${sectionId}_transition`);
            if (isVisible) group.classList.add('visible');
            else group.classList.remove('visible');
        }

        window.onclick = e => {
            if (!e.target.matches('.menu-dots') && !e.target.matches('.item-menu-dots')) {
                document.querySelectorAll('.menu-content, .sidebar-file-menu').forEach(m => m.classList.remove('show'));
            }
        };

        // Logic
        let currentGDriveId = null;
        let currentThesisCount = 0;
        let isSaving = false;
        let isBulkUpdating = false;
        const container = document.getElementById('theses-container');
        // –¢–µ–∫—Å—Ç –ø–æ–¥—Å–∫–∞–∑–∫–∏ –¥–ª—è –í–°–ï–• —Ç–µ–∑–∏—Å–æ–≤
        const thesisTooltipText = "–í –¥–∞–Ω–Ω—ã—Ö –±–ª–æ–∫–∞—Ö –∞–≤—Ç–æ—Ä –≤–∏–¥–µ–æ –ø—Ä–æ–ø–∏—Å—ã–≤–∞–µ—Ç –∫—Ä–∞—Ç–∫–∏–µ —Ç–µ–∑–∏—Å—ã –∏ –∫–ª—é—á–µ–≤—ã–µ –ø–æ–∏–Ω—Ç—ã –æ —Ç–æ–º, —á—Ç–æ –æ–Ω –º–æ–∂–µ—Ç —Ä–∞—Å—Å–∫–∞–∑–∞—Ç—å –Ω–∞ –∑–∞–¥–∞–Ω–Ω—É—é —Ç–µ–º—É. –≠—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –≥—Ä—É–±—ã–π –Ω–∞–±—Ä–æ—Å–æ–∫, –≤—Å–µ, —á—Ç–æ –ø–æ—è–≤–ª—è–µ—Ç—Å—è –≤ –≥–æ–ª–æ–≤–µ. –ü–æ—Å–ª–µ —Ç–æ–≥–æ, –∫–∞–∫ –≤—Å–µ —Ç–µ–∑–∏—Å—ã –∑–∞–ø–æ–ª–Ω–µ–Ω—ã - –ø—Ä–æ–¥—é—Å–µ—Ä —Å–æ—Ä—Ç–∏—Ä—É–µ—Ç –∏—Ö –≤ –ª–æ–≥–∏—á–µ—Å–∫–æ–º –ø–æ—Ä—è–¥–∫–µ, –¥–æ–±–∞–≤–ª—è–µ—Ç –ª–æ–≥–∏—á–µ—Å–∫–∏–µ/–Ω–∞–≤–æ–¥—è—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ), —á—Ç–æ–± —Ä–∞—Å–∫—Ä—ã—Ç—å —Ç–µ–º—É –∏–Ω—Ç–µ—Ä–µ—Å–Ω–µ–µ. –†—è–¥–æ–º —Å –∫–∞–∂–¥—ã–º —Ç–µ–∑–∏—Å–æ–º —Ç–∞–∫–∂–µ –≤–∞–∂–Ω–æ —É–∫–∞–∑–∞—Ç—å —Ö—Ä–æ–Ω–æ–º–µ—Ç—Ä–∞–∂.";
        const timeOptions = ["20 —Å–µ–∫", "30 - 60 —Å–µ–∫", "60 - 90 —Å–µ–∫", "2 –º–∏–Ω—É—Ç—ã"];

        function addThesis() {
            currentThesisCount++;
            let optionsHtml = `<option value="" disabled selected>–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å</option>`;
            timeOptions.forEach(opt => { optionsHtml += `<option value="${opt}">${opt}</option>`; });
            optionsHtml += `<option value="custom">–°–≤–æ–π –≤–∞—Ä–∏–∞–Ω—Ç...</option>`;

            const html = `
            <div class="thesis-block" id="thesis_block_${currentThesisCount}">
                <div class="thesis-header">
                    <div style="font-weight: 600; font-size: 1.1rem; display: flex; align-items: center; gap: 8px; flex-grow: 1;">
                        <svg class="drag-handle" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="9" cy="5" r="1" fill="currentColor"></circle>
                            <circle cx="9" cy="12" r="1" fill="currentColor"></circle>
                            <circle cx="9" cy="19" r="1" fill="currentColor"></circle>
                            <circle cx="15" cy="5" r="1" fill="currentColor"></circle>
                            <circle cx="15" cy="12" r="1" fill="currentColor"></circle>
                            <circle cx="15" cy="19" r="1" fill="currentColor"></circle>
                        </svg>
                        <div id="thesis_${currentThesisCount}_name" class="thesis-name-input" contenteditable="false" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–µ–∑–∏—Å–∞..."></div>
                        <span class="info-icon" data-tooltip="${thesisTooltipText}">?</span>
                    </div>
                    <div style="display: flex; gap: 8px; align-items: center;">
                        <select id="thesis_${currentThesisCount}_time" style="width: 160px;" onchange="handleCustomSelect(this)">
                            ${optionsHtml}
                        </select>
                        <button type="button" class="btn-edit-toggle" onclick="toggleSectionEdit('thesis_block_${currentThesisCount}', this)" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 1 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                        </button>
                        <div class="menu-container">
                            <button type="button" class="menu-dots" onclick="toggleMenu(${currentThesisCount})">‚ãÆ</button>
                            <div id="menu_${currentThesisCount}" class="menu-content">
                                <div class="menu-item">
                                    <label class="toggle-container" onclick="event.stopPropagation()">
                                        <span class="toggle-label">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</span>
                                        <div class="toggle-switch">
                                            <input type="checkbox" id="toggle_thesis_${currentThesisCount}"
                                                onchange="toggleComment('thesis_${currentThesisCount}', this.checked)">
                                            <span class="slider"></span>
                                        </div>
                                    </label>
                                </div>
                                <div class="menu-item">
                                    <label class="toggle-container" onclick="event.stopPropagation()">
                                        <span class="toggle-label">–ü–µ—Ä–µ—Ö–æ–¥</span>
                                        <div class="toggle-switch">
                                            <input type="checkbox" id="toggle_transition_thesis_${currentThesisCount}"
                                                onchange="toggleTransition('thesis_${currentThesisCount}', this.checked)">
                                            <span class="slider"></span>
                                        </div>
                                    </label>
                                </div>
                                <button type="button" class="btn-delete" onclick="removeThesis(${currentThesisCount})">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width: 14px; height: 14px;"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                                    –£–¥–∞–ª–∏—Ç—å –±–ª–æ–∫
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="grid-info wide" id="grid_thesis_${currentThesisCount}">
                    <div class="form-group"><label>–¢–µ–∑–∏—Å –∞–≤—Ç–æ—Ä–∞</label><div id="thesis_${currentThesisCount}_author" class="rich-textarea" contenteditable="false"></div></div>
                    <div class="form-group comment-group" id="group_thesis_${currentThesisCount}_comment"><label>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label><div id="thesis_${currentThesisCount}_producer" class="rich-textarea" contenteditable="false"></div></div>
                </div>
                <div class="form-group transition-group" id="group_thesis_${currentThesisCount}_transition" style="margin-top: 15px;">
                    <label>–ü–µ—Ä–µ—Ö–æ–¥</label>
                    <div id="thesis_${currentThesisCount}_transition" class="rich-textarea transition-textarea" contenteditable="false" placeholder="–¢–µ–∫—Å—Ç –ø–µ—Ä–µ—Ö–æ–¥–∞..."></div>
                </div>
            </div>`;
            container.insertAdjacentHTML('beforeend', html);
            renumberTheses();
            if (!isBulkUpdating) saveToGDrive(true);
        }

        function renumberTheses() {
            container.querySelectorAll('.thesis-name-input').forEach((input, index) => {
                const newDefault = `–¢–µ–∑–∏—Å ${index + 1}`;
                if (!input.innerText.trim() || /^–¢–µ–∑–∏—Å \d+$/.test(input.innerText.trim())) input.innerText = newDefault;
            });
        }

        function removeThesis(id) {
            document.getElementById('modalText').textContent = '–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —Ç–µ–∑–∏—Å?';
            const confirmBtn = document.getElementById('confirmBtn');
            confirmBtn.textContent = '–£–¥–∞–ª–∏—Ç—å';
            confirmBtn.className = 'btn-danger';
            openModal('confirmModal');
            confirmBtn.onclick = () => {
                document.getElementById(`thesis_block_${id}`)?.remove();
                renumberTheses();
                closeModal('confirmModal');
                showToast('–¢–µ–∑–∏—Å —É–¥–∞–ª–µ–Ω');
                if (!isBulkUpdating) saveToGDrive(true);
            };
        }

        // Data Management
        function getFormData() {
            const data = { theses: [] };
            document.querySelectorAll('input:not(.thesis-name-input), select').forEach(el => { if (el.id && el.id !== 'title' && el.type !== 'file') data[el.id] = el.value; });
            const mainTitle = document.getElementById('title'); if (mainTitle) data['title'] = mainTitle.innerText;
            document.querySelectorAll('.rich-textarea').forEach(el => { if (el.id && !el.id.startsWith('thesis_')) data[el.id] = el.innerHTML; });
            document.querySelectorAll('.thesis-block').forEach(block => {
                const id = block.id.replace('thesis_block_', '');
                data.theses.push({
                    name: document.getElementById(`thesis_${id}_name`).innerText,
                    time: document.getElementById(`thesis_${id}_time`).value,
                    author: document.getElementById(`thesis_${id}_author`).innerHTML,
                    producer: document.getElementById(`thesis_${id}_producer`).innerHTML,
                    transition: document.getElementById(`thesis_${id}_transition`).innerHTML
                });
            });
            document.querySelectorAll('input[id^="toggle_"]').forEach(el => data[el.id] = el.checked);
            return data;
        }

        function showEditor() {
            document.getElementById('welcomeScreen').style.display = 'none';
            document.getElementById('planForm').style.display = 'block';
            document.getElementById('sidebar-action-container').style.display = 'block';
        }

        function hideEditor() {
            document.getElementById('welcomeScreen').style.display = 'flex';
            document.getElementById('planForm').style.display = 'none';
            document.getElementById('sidebar-action-container').style.display = 'none';
            currentGDriveId = null;
            setSyncStatus('idle');
        }

        function setSyncStatus(state) {
            const statusEl = document.getElementById('syncStatus');
            if (!statusEl) return;
            if (state === 'saving') {
                statusEl.innerHTML = `
                    <svg width="24" height="24" viewBox="0 0 24 24"><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.6" d="M14 16h5v5M10 8H5V3m14.418 6.003A8 8 0 0 0 5.086 7.976m-.504 7.021a8 8 0 0 0 14.331 1.027"/></svg>
                    <span>–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...</span>`;
                statusEl.style.opacity = '1';
            } else if (state === 'saved') {
                statusEl.innerHTML = `
                    <svg width="24" height="24" viewBox="0 0 24 24"><g fill="currentColor" stroke="currentColor" stroke-width="0.3"><path d="M15.03 10.47a.75.75 0 0 1 0 1.06l-3.5 3.5a.75.75 0 0 1-1.06 0l-2-2a.75.75 0 0 1 1.06-1.06L11 13.44l2.97-2.97a.75.75 0 0 1 1.06 0"/><path d="M12.932 6.208a3.91 3.91 0 0 0-3.524 2.214a.75.75 0 0 1-.947.373a4.375 4.375 0 1 0-1.586 8.455h11.648a2.978 2.978 0 1 0-.77-5.855a.75.75 0 0 1-.939-.812a3.91 3.91 0 0 0-3.882-4.374m-4.552.986A5.41 5.41 0 0 1 18.332 9.8a4.478 4.478 0 1 1 .191 8.951H6.875A5.875 5.875 0 1 1 8.38 7.194"/></g></svg>
                    <span>–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –Ω–∞ –î–∏—Å–∫–µ.</span>`;
                statusEl.style.opacity = '1';
            } else {
                statusEl.style.opacity = '0';
            }
        }

        function applyData(data) {
            isBulkUpdating = true; // –û—Ç–∫–ª—é—á–∞–µ–º –∞–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–∞ –≤—Ä–µ–º—è –∑–∞–ª–∏–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö
            showEditor();
            container.innerHTML = ''; currentThesisCount = 0;

            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
            document.querySelectorAll('.is-editing').forEach(el => {
                el.classList.remove('is-editing');
                const btn = el.querySelector('.btn-edit-toggle');
                if (btn) {
                    btn.innerHTML = `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 1 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>`;
                    btn.title = "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å";
                }
                el.querySelectorAll('.rich-textarea, .thesis-name-input').forEach(f => f.setAttribute('contenteditable', 'false'));
            });

            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –æ–±–ª–æ–∂–∫—É –Ω–∞ –¥–µ—Ñ–æ–ª—Ç–Ω—É—é –ø–µ—Ä–µ–¥ –∑–∞–≥—Ä—É–∑–∫–æ–π –Ω–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö
            const coverPreview = document.getElementById('coverPreview');
            if (coverPreview) {
                coverPreview.src = 'https://placehold.co/800x450?text=%D0%97%D0%B0%D0%B3%D1%80%D1%83%D0%B7%D0%B8%D1%82%D0%B5+%D0%9F%D1%80%D0%B5%D0%B2%D1%8C%D1%8E';
            }
            if (document.getElementById('coverUrl')) document.getElementById('coverUrl').value = '';

            for (const key in data) {
                if (key !== 'theses') {
                    const el = document.getElementById(key);
                    if (el) {
                        if (el.classList.contains('rich-textarea') || el.id === 'title' || el.classList.contains('thesis-name-input')) {
                            if (el.id === 'title' || el.classList.contains('thesis-name-input')) el.innerText = data[key];
                            else el.innerHTML = data[key];
                        } else {
                            if (el.tagName === 'SELECT' && data[key]) {
                                // –ï—Å–ª–∏ –∑–Ω–∞—á–µ–Ω–∏—è –Ω–µ—Ç –≤ —Å–ø–∏—Å–∫–µ –æ–ø—Ü–∏–π (—Å–≤–æ–π –≤–∞—Ä–∏–∞–Ω—Ç), –¥–æ–±–∞–≤–ª—è–µ–º –µ–≥–æ
                                if (!Array.from(el.options).some(o => o.value === data[key])) {
                                    const newOpt = document.createElement('option');
                                    newOpt.value = data[key];
                                    newOpt.text = data[key];
                                    el.add(newOpt, el.options[el.options.length - 1]);
                                }
                            }
                            el.value = data[key];
                        }
                        if (el.tagName === 'SELECT') updateSelectStyle(el);
                        if (key === 'coverUrl' && data[key]) document.getElementById('coverPreview').src = data[key];
                    }
                }
            }
            if (data.theses) {
                data.theses.forEach(t => {
                    addThesis(); const id = currentThesisCount;
                    const timeEl = document.getElementById(`thesis_${id}_time`);
                    if (!Array.from(timeEl.options).some(o => o.value === t.time)) {
                        const newOpt = document.createElement('option'); newOpt.value = t.time; newOpt.text = t.time;
                        timeEl.add(newOpt, timeEl.options[timeEl.options.length - 1]);
                    }
                    timeEl.value = t.time; updateSelectStyle(timeEl);
                    document.getElementById(`thesis_${id}_name`).innerText = t.name || '';
                    document.getElementById(`thesis_${id}_author`).innerHTML = t.author || '';
                    document.getElementById(`thesis_${id}_producer`).innerHTML = t.producer || '';
                    document.getElementById(`thesis_${id}_transition`).innerHTML = t.transition || '';

                    const toggleId = `toggle_thesis_${id}`;
                    if (data[toggleId]) {
                        const toggleEl = document.getElementById(toggleId);
                        if (toggleEl) {
                            toggleEl.checked = true;
                            toggleComment(`thesis_${id}`, true);
                        }
                    }

                    const toggleTransitionId = `toggle_transition_thesis_${id}`;
                    if (data[toggleTransitionId]) {
                        const toggleEl = document.getElementById(toggleTransitionId);
                        if (toggleEl) {
                            toggleEl.checked = true;
                            toggleTransition(`thesis_${id}`, true);
                        }
                    }
                });
            }
            ['intro', 'outro'].forEach(section => {
                const toggleId = `toggle_${section}`;
                const commentEl = document.getElementById(`${section}_comment`);
                const shouldToggle = data[toggleId] === true || (commentEl && commentEl.innerHTML.trim() !== '' && commentEl.innerHTML !== '<br>');
                const toggle = document.getElementById(toggleId);
                if (toggle) { toggle.checked = shouldToggle; toggleComment(section, shouldToggle); }
            });

            isBulkUpdating = false; // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ä–µ–∂–∏–º –∞–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
        }

        // Google Drive
        async function refreshSidebarFiles() {
            const list = document.getElementById('sidebar-file-list');
            if (!list || !window.currentUser) return;

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ª–æ–∞–¥–µ—Ä —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Å–ø–∏—Å–æ–∫ —Å–æ–≤—Å–µ–º –ø—É—Å—Ç–æ–π
            if (list.children.length === 0) {
                list.innerHTML = '<div style="padding: 20px; text-align: center;"><span class="loader" style="border-bottom-color:transparent; border-color:var(--primary-color); display:inline-block"></span></div>';
            }

            try {
                const files = await GDriveService.listFiles();
                if (files.length === 0) {
                    list.innerHTML = '<div style="padding: 20px; color: #94a3b8; font-size: 0.85rem; text-align: center;">–ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –ø–ª–∞–Ω–æ–≤</div>';
                    return;
                }

                files.sort((a, b) => new Date(b.modifiedTime) - new Date(a.modifiedTime));

                // –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä, —á—Ç–æ–±—ã –Ω–µ –¥–µ—Ä–≥–∞—Ç—å DOM
                const fragment = document.createDocumentFragment();

                files.forEach(f => {
                    const cleanName = f.name.replace('.json', '');
                    const wrapper = document.createElement('div');
                    wrapper.className = 'sidebar-file-wrapper';
                    wrapper.dataset.id = f.id;

                    const btn = document.createElement('button');
                    btn.className = 'sidebar-nav-item';
                    if (currentGDriveId === f.id) btn.classList.add('active');
                    btn.innerHTML = `<svg width="24" height="24" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-linejoin="round" stroke-width="2"><path stroke-linecap="round" d="M4 4v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8.342a2 2 0 0 0-.602-1.43l-4.44-4.342A2 2 0 0 0 13.56 2H6a2 2 0 0 0-2 2m5 9h6m-6 4h3"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/></g></svg> <span style="overflow:hidden; text-overflow:ellipsis; white-space:nowrap">${cleanName}</span>`;
                    btn.onclick = () => loadFromGDrive(f.id);

                    const menuBtn = document.createElement('button');
                    menuBtn.className = 'item-menu-dots';
                    menuBtn.innerHTML = '‚ãÆ';
                    menuBtn.onclick = (e) => {
                        e.stopPropagation();
                        toggleFileMenu(f.id, e);
                    };

                    const menu = document.createElement('div');
                    menu.id = `file_menu_${f.id}`;
                    menu.className = 'sidebar-file-menu';
                    menu.innerHTML = `
                        <button onclick="promptRenameFile('${f.id}', '${cleanName}')">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                            –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å
                        </button>
                        <button class="btn-menu-delete" onclick="confirmDeleteFile('${f.id}', '${cleanName}')">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                            –£–¥–∞–ª–∏—Ç—å
                        </button>
                    `;

                    wrapper.appendChild(btn);
                    wrapper.appendChild(menuBtn);
                    wrapper.appendChild(menu);
                    fragment.appendChild(wrapper);
                });

                list.innerHTML = '';
                list.appendChild(fragment);
            } catch (err) {
                const isAuthError = err.message.includes('–∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è') ||
                    err.message.includes('–∏—Å—Ç–µ–∫–ª–∞') ||
                    err.message.includes('401') ||
                    err.message.includes('–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ') ||
                    !GDriveService.getAccessToken();
                if (isAuthError) {
                    list.innerHTML = `
                        <div style="padding: 20px; text-align: center;">
                            <div style="color: #64748b; font-size: 0.85rem; margin-bottom: 12px;">–¢—Ä–µ–±—É–µ—Ç—Å—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ Google Drive</div>
                            <button onclick="window.openAuthModal()" class="btn-sidebar-action primary" style="padding: 8px 12px; font-size: 0.8rem; height: auto; width: auto; margin: 0 auto;">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right:4px"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"></path><polyline points="10 17 15 12 10 7"></polyline><line x1="15" y1="12" x2="3" y2="12"></line></svg>
                                –ü–æ–¥–∫–ª—é—á–∏—Ç—å
                            </button>
                        </div>`;
                } else {
                    list.innerHTML = '<div style="padding: 20px; color: #ef4444; font-size: 0.85rem; text-align: center;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>';
                }
            }
        }

        function updateSidebarSelection() {
            document.querySelectorAll('.sidebar-file-wrapper').forEach(w => {
                const btn = w.querySelector('.sidebar-nav-item');
                if (btn) {
                    if (w.dataset.id === currentGDriveId) btn.classList.add('active');
                    else btn.classList.remove('active');
                }
            });
        }

        function toggleFileMenu(id, event) {
            document.querySelectorAll('.sidebar-file-menu').forEach(m => { if (m.id !== `file_menu_${id}`) m.classList.remove('show'); });
            const menu = document.getElementById(`file_menu_${id}`);
            if (menu) menu.classList.toggle("show");
        }

        function promptRenameFile(id, oldName) {
            const input = document.getElementById('promptInput');
            input.value = oldName;
            document.getElementById('promptTitle').textContent = '–ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å';
            document.getElementById('promptText').textContent = '–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ:';
            openModal('promptModal');
            document.getElementById('promptBtn').onclick = async () => {
                const newName = input.value.trim();
                if (newName && newName !== oldName) {
                    try {
                        await GDriveService.renameFile(id, newName);
                        showToast('–§–∞–π–ª –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω');
                        refreshSidebarFiles();
                        if (currentGDriveId === id) {
                            document.getElementById('title').innerText = newName;
                        }
                    } catch (e) { showToast(e.message, 'error'); }
                }
                closeModal('promptModal');
            };
        }

        function confirmDeleteFile(id, name) {
            document.getElementById('modalText').textContent = `–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —Ñ–∞–π–ª "${name}"?`;
            const confirmBtn = document.getElementById('confirmBtn');
            confirmBtn.textContent = '–£–¥–∞–ª–∏—Ç—å';
            confirmBtn.className = 'btn-danger';
            openModal('confirmModal');
            confirmBtn.onclick = async () => {
                try {
                    await GDriveService.deleteFile(id);
                    showToast('–§–∞–π–ª —É–¥–∞–ª–µ–Ω');
                    if (currentGDriveId === id) {
                        hideEditor();
                    }
                    refreshSidebarFiles();
                } catch (e) { showToast(e.message, 'error'); }
                closeModal('confirmModal');
            };
        }

        async function saveToGDrive(silent = false) {
            if (!window.currentUser) {
                if (!silent) {
                    showToast('–í–æ–π–¥–∏—Ç–µ —á–µ—Ä–µ–∑ Google', 'error');
                    if (window.openAuthModal) window.openAuthModal();
                }
                return;
            }

            if (isSaving) return; // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã
            isSaving = true;

            setSyncStatus('saving');

            try {
                const title = document.getElementById('title').innerText.trim() || '–ù–æ–≤—ã–π –ø–ª–∞–Ω';
                const result = await GDriveService.saveFile(title, getFormData(), currentGDriveId);
                if (result && result.id) currentGDriveId = result.id;

                if (!silent) showToast('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –≤ –æ–±–ª–∞–∫–æ!');
                setSyncStatus('saved');
                refreshSidebarFiles();
            } catch (err) {
                if (!silent) showToast(err.message, 'error');
                setSyncStatus('idle');
            } finally {
                isSaving = false;
            }
        }

        async function loadFromGDrive(id) {
            try {
                const form = document.getElementById('planForm');
                form.classList.add('content-fade'); // –ó–∞–ø—É—Å–∫–∞–µ–º –∑–∞—Ç—É—Ö–∞–Ω–∏–µ

                // –î–∞–µ–º 250–º—Å –Ω–∞ –∞–Ω–∏–º–∞—Ü–∏—é –∑–∞—Ç—É—Ö–∞–Ω–∏—è –¥–æ —Å–º–µ–Ω—ã –¥–∞–Ω–Ω—ã—Ö
                await new Promise(r => setTimeout(r, 250));

                const data = await GDriveService.getFile(id);
                applyData(data);
                currentGDriveId = id;
                updateSidebarSelection();

                form.classList.remove('content-fade'); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ
            }
            catch (err) {
                document.getElementById('planForm').classList.remove('content-fade');
                showToast(err.message, 'error');
            }
        }

        async function createNewPlan() {
            const form = document.getElementById('planForm');
            form.classList.add('content-fade'); // –ó–∞–ø—É—Å–∫–∞–µ–º –∑–∞—Ç—É—Ö–∞–Ω–∏–µ

            // –î–∞–µ–º 250–º—Å –Ω–∞ –∞–Ω–∏–º–∞—Ü–∏—é –∑–∞—Ç—É—Ö–∞–Ω–∏—è –¥–æ —Å–º–µ–Ω—ã –¥–∞–Ω–Ω—ã—Ö
            await new Promise(r => setTimeout(r, 250));

            isBulkUpdating = true; // –û—Ç–∫–ª—é—á–∞–µ–º –∞–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–∞ –≤—Ä–µ–º—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
            showEditor();
            currentGDriveId = null;
            document.getElementById('planForm').reset();

            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –æ–±–ª–æ–∂–∫—É –∏ –≤—Å—ë –æ—Å—Ç–∞–ª—å–Ω–æ–µ
            document.getElementById('coverUrl').value = '';
            document.getElementById('coverPreview').src = 'https://placehold.co/800x450?text=%D0%97%D0%B0%D0%B3%D1%80%D1%83%D0%B7%D0%B8%D1%82%D0%B5+%D0%9F%D1%80%D0%B5%D0%B2%D1%8C%D1%8E';
            document.getElementById('title').innerText = '–ù–æ–≤—ã–π –ø–ª–∞–Ω';
            document.querySelectorAll('.rich-textarea').forEach(el => el.innerHTML = '');
            container.innerHTML = ''; currentThesisCount = 0;

            for (let i = 0; i < 3; i++) addThesis();

            isBulkUpdating = false; // –í–∫–ª—é—á–∞–µ–º –æ–±—Ä–∞—Ç–Ω–æ

            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —É–Ω–∏–∫–∞–ª—å–Ω–æ–µ –∏–º—è
            const existingNames = Array.from(document.querySelectorAll('.sidebar-nav-item span')).map(s => s.innerText.trim());
            let baseName = '–ù–æ–≤—ã–π –ø–ª–∞–Ω';
            let newName = baseName;
            let counter = 1;
            while (existingNames.includes(newName)) {
                newName = `${baseName} ${counter++}`;
            }
            document.getElementById('title').innerText = newName;

            form.classList.remove('content-fade'); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ

            // –°—Ä–∞–∑—É —Å–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞ –¥–∏—Å–∫ (—Ç–µ–ø–µ—Ä—å —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑!)
            if (window.currentUser) {
                await saveToGDrive();
            } else {
                showToast('–ù–æ–≤—ã–π –ø–ª–∞–Ω —Å–æ–∑–¥–∞–Ω –ª–æ–∫–∞–ª—å–Ω–æ', 'success');
            }
        }

        // Image
        async function uploadImage(input) {
            const file = input.files[0]; if (!file) return;
            const loader = document.getElementById('uploadLoader'); const btn = document.getElementById('uploadBtn');
            loader.style.display = 'inline-block'; btn.style.display = 'none';
            try {
                const fd = new FormData(); fd.append('image', file);
                const res = await fetch('https://api.imgbb.com/1/upload?key=fbd88ce7045582e4c4176c67de93ceee', { method: 'POST', body: fd });
                const json = await res.json();
                if (json.success) {
                    document.getElementById('coverUrl').value = json.data.url;
                    document.getElementById('coverPreview').src = json.data.url;
                    showToast('–û–±–ª–æ–∂–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞');
                    saveToGDrive(true); // –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ä—Ç–∏–Ω–∫–∏
                }
            } catch (e) { showToast('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏', 'error'); }
            finally { loader.style.display = 'none'; btn.style.display = 'inline-block'; }
        }


        // Init
        window.addEventListener('load', () => {
            refreshSidebarFiles();
            document.querySelectorAll('select').forEach(updateSelectStyle);

            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Drag & Drop –¥–ª—è —Ç–µ–∑–∏—Å–æ–≤
            new Sortable(document.getElementById('theses-container'), {
                handle: '.drag-handle',
                animation: 150,
                ghostClass: 'sortable-ghost',
                onEnd: () => {
                    renumberTheses();
                    saveToGDrive(true);
                }
            });
        });
        window.addEventListener('authChanged', e => {
            const user = e.detail.user;
            const nameEl = document.getElementById('sidebar-user-name');
            const emailEl = document.getElementById('sidebar-user-email');
            const avatarEl = document.getElementById('sidebar-user-avatar');

            if (user) {
                nameEl.textContent = user.displayName || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
                emailEl.textContent = user.email;
                avatarEl.src = user.photoURL || `https://via.placeholder.com/36/CCCCCC/FFFFFF?text=${(user.displayName || 'U')[0]}`;
            } else {
                nameEl.textContent = '–ì–æ—Å—Ç—å';
                emailEl.textContent = '–í–æ–π—Ç–∏ –≤ –∞–∫–∫–∞—É–Ω—Ç';
                avatarEl.src = 'https://i.ibb.co/Z6vRKK9x/0000000.jpg';
            }
            refreshSidebarFiles();
        });

        window.addEventListener('googleTokenChanged', () => {
            refreshSidebarFiles();
            showToast('–î–æ—Å—Ç—É–ø –∫ Google Drive –æ–±–Ω–æ–≤–ª–µ–Ω', 'success');
        });
        document.addEventListener('paste', e => { if (e.target.classList.contains('rich-textarea')) { e.preventDefault(); document.execCommand('insertText', false, e.clipboardData.getData('text/plain')); } });

        // NEW LOGIC: Section-based editing
        function toggleSectionEdit(containerId, btn) {
            const container = document.getElementById(containerId);
            const isEditing = container.classList.toggle('is-editing');
            const fields = container.querySelectorAll('.rich-textarea, .thesis-name-input');

            if (isEditing) {
                // –í–∫–ª—é—á–∞–µ–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
                fields.forEach(f => f.setAttribute('contenteditable', 'true'));
                btn.innerHTML = `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>`;
                btn.title = "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å";

                // –§–æ–∫—É—Å –Ω–∞ –ø–µ—Ä–≤–æ–µ –ø–æ–ª–µ
                if (fields.length > 0) fields[0].focus();
            } else {
                // –í—ã–∫–ª—é—á–∞–µ–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
                fields.forEach(f => f.setAttribute('contenteditable', 'false'));
                btn.innerHTML = `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 1 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>`;
                btn.title = "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å";

                // –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞
                saveToGDrive(true);
            }
        }

        // –õ–æ–≥–∏–∫–∞ –¥–≤—É—Ö—ç—Ç–∞–ø–Ω–æ–≥–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (REMOVED)

        // –°–Ω–∏–º–∞–µ–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–∏ –ø–æ—Ç–µ—Ä–µ —Ñ–æ–∫—É—Å–∞ + –∞–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
        let hasChanged = false;
        document.addEventListener('input', (e) => {
            if (e.target.closest('.rich-textarea, .thesis-name-input')) {
                hasChanged = true;
            }
        });

        document.addEventListener('change', (e) => {
            if (e.target.tagName === 'SELECT' || e.target.type === 'checkbox') {
                saveToGDrive(true); // –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–ª—è —Å–µ–ª–µ–∫—Ç–æ–≤ –∏ —á–µ–∫–±–æ–∫—Å–æ–≤ —Å—Ä–∞–∑—É
            }
        });

        document.addEventListener('focusout', function (e) {
            // –ë–æ–ª—å—à–µ –Ω–µ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º contenteditable –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏, —á—Ç–æ–±—ã –Ω–µ –º–µ—à–∞—Ç—å –∫–Ω–æ–ø–∫–µ "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å"
            // –ù–æ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
            if (hasChanged) {
                // saveToGDrive(true); // –¢–µ–ø–µ—Ä—å —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ –≥–∞–ª–æ—á–∫—É –∏–ª–∏ –µ—Å–ª–∏ —Ñ–æ–∫—É—Å —É—à–µ–ª —Å–æ–≤—Å–µ–º –∏–∑ –±–ª–æ–∫–∞?
                // –û—Å—Ç–∞–≤–∏–º —Ç–∏—Ö–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–∞ —Ñ–æ–Ω–µ
                saveToGDrive(true);
                hasChanged = false;
            }
        });
    </script>

    <script type="module" src="auth-widget.js"></script>
    <script type="module" src="nav-widget.js"></script>
</body>

</html>