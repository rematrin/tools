<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Auto-DJ Station</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üéß</text></svg>">

<style>
/* === –ë–ê–ó–û–í–´–ï –°–¢–ò–õ–ò === */
:root {
    --primary: #6200ee;
    --primary-dark: #5000ca;
    --neon-blue: #00e5ff;
    --neon-pink: #ff0055;
    --bg-color: #f6f7fb;
    --border-color: #e6e9f2;
    --card-bg: #fff;
    --active-bg: #eef2ff;
    --text-main: #202124;
    --text-sec: #555;
}

*{box-sizing:border-box}
body{
    margin:0;
    font-family:system-ui,-apple-system,sans-serif;
    background:var(--bg-color);
    color:#0c0c0d;
    display: flex;
    justify-content: center;
    min-height: 100vh;
    padding: 20px 0;
}
.wrap{
    width: 100%;
    max-width:900px;
    margin:0 auto;
    padding:0 14px; 
}
h1{margin:0 0 20px;font-size:1.4rem;text-align:center;color:var(--text-main);}

/* --- –ö–∞—Ä—Ç–æ—á–∫–∞ --- */
.card{
    background:var(--card-bg);
    border:1px solid var(--border-color);
    border-radius:16px;
    padding:20px; 
    box-shadow:0 4px 12px rgba(0,0,0,0.03);
    min-height: 550px;
}

#player-container {
    display: flex;
    gap: 25px;
    height: 100%;
}

/* --- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ (–ü–ª–µ–π–ª–∏—Å—Ç) --- */
#playlist-sidebar {
    width: 40%;
    flex-shrink: 0;
    display: flex;
    flex-direction: column;
    max-height: 600px;
}
#playlist-header-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
}
#playlist-sidebar h2 { font-size: 1rem; margin: 0; color: var(--text-main); font-weight: 700; }

.shuffle-btn {
    border: 1px solid var(--border-color); background: transparent;
    padding: 6px 12px; border-radius: 8px; font-size: 0.8rem;
    color: var(--text-sec); cursor: pointer;
    display: flex; align-items: center; gap: 6px; transition: 0.2s;
}
.shuffle-btn:hover { background: rgba(98, 0, 238, 0.05); color: var(--primary); border-color: var(--primary); }
.shuffle-btn svg { width: 14px; height: 14px; }

.playlist-scroll-area {
    flex-grow: 1;
    overflow-y: auto;
    padding-right: 6px;
}
.playlist-scroll-area::-webkit-scrollbar { width: 4px; }
.playlist-scroll-area::-webkit-scrollbar-thumb { background: #ddd; border-radius: 2px; }

.playlist-item {
    display: flex; gap: 12px; padding: 10px; margin-bottom: 8px;
    border-radius: 10px; cursor: pointer; transition: 0.2s;
    background: #fafbff; border: 1px solid transparent;
    position: relative;
    align-items: center;
}
.playlist-item:hover { background: #f0f2f5; }
.playlist-item.active { background: var(--active-bg); border-color: var(--primary); }

.playlist-thumb {
    width: 64px; height: 36px; /* –í–ï–†–ù–£–õ–ò 16:9 */
    flex-shrink: 0;
    border-radius: 6px; overflow: hidden; border: 1px solid #eee; background: #000;
}
.playlist-thumb img { width: 100%; height: 100%; object-fit: cover; }

.playlist-info { flex: 1; display: flex; flex-direction: column; justify-content: center; overflow: hidden; }
.playlist-title {
    font-size: 0.85rem; font-weight: 600; line-height: 1.3;
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: var(--text-main);
}

.import-box {
    margin-top: 15px;
    display: flex; gap: 10px;
    padding-top: 15px; border-top: 1px solid var(--border-color);
}
.import-input {
    flex-grow: 1; padding: 10px; border: 1px solid var(--border-color);
    border-radius: 8px; font-size: 0.85rem; outline: none; background: #f9f9f9;
}
.import-input:focus { border-color: var(--primary); background: #fff; }
.btn-add {
    background: var(--primary); color: white; border: none;
    width: 40px; border-radius: 8px; cursor: pointer; font-size: 1.2rem;
    display: flex; align-items: center; justify-content: center; transition: 0.2s;
}
.btn-add:hover { background: var(--primary-dark); }


/* --- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ (–ü–ª–µ–µ—Ä) --- */
#main-player-area {
    width: 60%; flex-grow: 1;
    display: flex; flex-direction: column;
    align-items: center; text-align: center;
}

/* 1. –í–∫–ª–∞–¥–∫–∏ (–°–≤–µ—Ä—Ö—É) */
.mode-switcher {
    display: flex; background: #f0f2f5; padding: 4px;
    border-radius: 12px; gap: 4px; width: 100%; max-width: 300px; margin-bottom: 20px;
}
.mode-btn {
    flex: 1; border: none; background: transparent; padding: 8px;
    border-radius: 8px; font-size: 0.85rem; font-weight: 600; color: var(--text-sec);
    cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;
    transition: 0.2s; font-family: inherit;
}
.mode-btn:hover { background: rgba(0,0,0,0.05); }
.mode-btn.active { background: #fff; color: var(--primary); box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
.mode-btn svg { width: 16px; height: 16px; }


/* 2. –í–∏–∑—É–∞–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä */
#visual-container {
    width: 100%;
    max-width: 480px;
    aspect-ratio: 16 / 9;
    margin-bottom: 15px;
    border-radius: 12px;
    overflow: hidden;
    position: relative;
    background: #000;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(0,0,0,0.08);
}
.deck-wrapper {
    position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    transition: opacity 1s ease;
}
.deck-active { opacity: 1; z-index: 10; }
.deck-bg { opacity: 0; z-index: 5; pointer-events: none; }

#cover-overlay {
    position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    object-fit: cover; z-index: 20;
    opacity: 0; 
    pointer-events: none; 
    transition: opacity 0.3s;
}

/* –õ–û–ì–ò–ö–ê –†–ï–ñ–ò–ú–û–í */
.mode-audio #cover-overlay { 
    opacity: 1; 
    pointer-events: auto; /* –ö–∞—Ä—Ç–∏–Ω–∫–∞ –ª–æ–≤–∏—Ç –∫–ª–∏–∫ */
    cursor: default;
}


/* 3. –ò–Ω—Ñ–æ –æ —Ç—Ä–µ–∫–µ */
#current-track-info { 
    font-size: 1.1rem; font-weight: 700; color: var(--text-main); 
    min-height: 24px; margin-bottom: 12px; 
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 90%;
}


/* 4. –ö–Ω–æ–ø–∫–∞ CROSSFADE */
#meta-info-row {
    display: flex; align-items: center; justify-content: center;
    margin-bottom: 20px; height: 40px;
}
.btn-mix {
    background: #222; 
    border: 1px solid #333; 
    color: #fff;
    padding: 10px 24px; 
    border-radius: 30px; 
    font-weight: 700;
    font-size: 0.8rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    display: flex; align-items: center; gap: 8px;
}
.btn-mix:hover { 
    background: #111;
    border-color: var(--neon-blue); 
    color: var(--neon-blue);
    box-shadow: 0 0 15px rgba(0, 229, 255, 0.4);
    transform: translateY(-2px);
}
.status-badge {
    background: var(--neon-pink); 
    color: white; 
    padding: 10px 24px; 
    border-radius: 30px; 
    font-weight: 800;
    font-size: 0.8rem;
    text-transform: uppercase;
    letter-spacing: 1px;
    box-shadow: 0 0 20px rgba(255, 0, 85, 0.6);
    animation: pulse-mix 1.5s infinite;
    cursor: default;
}
@keyframes pulse-mix {
    0% { transform: scale(1); }
    50% { transform: scale(1.05); }
    100% { transform: scale(1); }
}


/* 5. –ü–æ–ª–æ—Å–∞ –ø–µ—Ä–µ–º–æ—Ç–∫–∏ */
.seek-container {
    width: 100%; max-width: 480px; display: flex; align-items: center; gap: 12px;
    color: #999; font-size: 0.75rem; font-variant-numeric: tabular-nums;
    margin-bottom: 25px;
}
input[type=range] {
    flex-grow: 1; height: 4px; border-radius: 2px;
    accent-color: var(--primary); cursor: pointer;
}

/* 6. –ö–æ–Ω—Ç—Ä–æ–ª—ã */
#controls { display: flex; gap: 20px; align-items: center; }

.nav-btn {
    display: flex; align-items: center; justify-content: center;
    width: 48px; height: 48px;
    border-radius: 50%; border: none; background: var(--primary); color: #fff;
    cursor: pointer; transition: 0.2s; box-shadow: 0 4px 10px rgba(98, 0, 238, 0.3);
}
#playPauseBtn { width: 64px; height: 64px; background: var(--primary-dark); }
.nav-btn:hover { transform: scale(1.1); box-shadow: 0 6px 15px rgba(98, 0, 238, 0.4); }
.nav-btn:active { transform: scale(0.95); }

.nav-btn svg { width: 24px; height: 24px; }
#playPauseBtn svg { width: 32px; height: 32px; }


/* –ê–¥–∞–ø—Ç–∏–≤ */
@media (max-width: 768px) {
    #player-container { flex-direction: column; }
    #playlist-sidebar { width: 100%; max-height: 300px; margin-bottom: 20px; border-right: none; border-bottom: 1px solid #eee; padding-bottom: 20px;}
    #main-player-area { width: 100%; }
}
</style>
</head>
<body>

<div class="wrap">
    <h1>üéß Auto-DJ Station</h1>

    <div class="card">
        <div id="player-container">
            
            <div id="playlist-sidebar">
                <div id="playlist-header-row">
                    <h2>–°–ø–∏—Å–æ–∫ —Å—Ç–∞–Ω—Ü–∏–π</h2>
                    <button class="shuffle-btn" onclick="shufflePlaylist()" title="–ü–µ—Ä–µ–º–µ—à–∞—Ç—å">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="16 3 21 3 21 8"></polyline><line x1="4" y1="20" x2="21" y2="3"></line><polyline points="21 16 21 21 16 21"></polyline><line x1="15" y1="15" x2="21" y2="21"></line><line x1="4" y1="4" x2="9" y2="9"></line></svg>
                        –ü–µ—Ä–µ–º–µ—à–∞—Ç—å
                    </button>
                </div>
                
                <div class="playlist-scroll-area" id="playlist-list">
                    </div>

                <div class="import-box">
                    <input type="text" class="import-input" id="urlInput" placeholder="–°—Å—ã–ª–∫–∞ –Ω–∞ YouTube...">
                    <button class="btn-add" onclick="handleInput()">+</button>
                </div>
            </div>

            <div id="main-player-area" class="mode-video">
                
                <div class="mode-switcher">
                    <button class="mode-btn active" onclick="setMode('video')" id="btn-video">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect><line x1="8" y1="21" x2="16" y2="21"></line><line x1="12" y1="17" x2="12" y2="21"></line></svg>
                        <span>–í–∏–¥–µ–æ</span>
                    </button>
                    <button class="mode-btn" onclick="setMode('audio')" id="btn-audio">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 18V5l12-2v13"></path><circle cx="6" cy="18" r="3"></circle><circle cx="18" cy="16" r="3"></circle></svg>
                        <span>–ê—É–¥–∏–æ</span>
                    </button>
                </div>

                <div id="visual-container">
                    <div id="wrapper1" class="deck-wrapper deck-active">
                        <div id="player1" style="width:100%; height:100%;"></div>
                    </div>
                    <div id="wrapper2" class="deck-wrapper deck-bg">
                        <div id="player2" style="width:100%; height:100%;"></div>
                    </div>
                    <img id="cover-overlay" src="" alt="Cover">
                </div>

                <div id="current-track-info">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                
                <div id="meta-info-row">
                    <button id="mixBtn" class="btn-mix" onclick="forceCrossfade()">
                        ‚ö° –°–¥–µ–ª–∞—Ç—å Crossfade
                    </button>
                </div>

                <div class="seek-container">
                    <span id="currentTime">0:00</span>
                    <input type="range" id="progressBar" value="0" step="0.1">
                    <span id="totalTime">0:00</span>
                </div>

                <div id="controls">
                    <button id="prevBtn" class="nav-btn" onclick="prevTrack()">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path d="M6 6h2v12H6zm3.5 6l8.5 6V6l-8.5 6z"/>
                        </svg>
                    </button>
                    
                    <button id="playPauseBtn" class="nav-btn" onclick="togglePlay()">
                        <svg id="icon-play" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>
                        <svg id="icon-pause" viewBox="0 0 24 24" fill="currentColor" style="display:none;"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
                    </button>
                    
                    <button id="nextBtn" class="nav-btn" onclick="nextTrack()">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path d="M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z"/>
                        </svg>
                    </button>
                </div>

            </div>
        </div>
    </div>
</div>

<script>
    // --- –î–ê–ù–ù–´–ï –ò –ù–ê–°–¢–†–û–ô–ö–ò ---
    let playlist = [
        { id: "CsQ86xtn2V0", title: "nyan.mp3 - –ó–∞–±—ã–≤–∞–ª" },
        { id: "xbpQ8TXfTi0", title: "nyan.mp3 - –ù—É-–Ω—É-–Ω—É" },
        { id: "Cm-wq1djnzI", title: "nyan.mp3 - Double Door" },
        { id: "jfKfPfyJRdk", title: "Lofi Girl - Hip Hop Radio" }
    ];

    const CROSSFADE_DURATION = 8; 

    // --- YOUTUBE API ---
    var tag = document.createElement('script');
    tag.src = "https://www.youtube.com/iframe_api";
    var firstScriptTag = document.getElementsByTagName('script')[0];
    firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

    var p1, p2;
    var currentDeck = 1; 
    var trackIndex = 0;
    var isPlaying = false;
    var isCrossfading = false;
    var isDragging = false;
    var updateTimer;
    var currentMode = 'video';
    var playersReadyCount = 0;

    function onYouTubeIframeAPIReady() {
        const playerVars = { 
            controls: 0, 
            disablekb: 1, 
            rel: 0, 
            iv_load_policy: 3,
            origin: window.location.origin 
        };

        p1 = new YT.Player('player1', { 
            height: '100%', width: '100%', 
            playerVars: playerVars,
            events: { 'onReady': onPlayerReady, 'onStateChange': onPlayerStateChange } 
        });
        p2 = new YT.Player('player2', { 
            height: '100%', width: '100%', 
            playerVars: playerVars,
            events: { 'onReady': onPlayerReady, 'onStateChange': onPlayerStateChange } 
        });
        
        renderPlaylist();
        fetchTitlesForPlaylist();

        const range = document.getElementById('progressBar');
        range.addEventListener('input', () => isDragging = true);
        range.addEventListener('change', () => { isDragging = false; seekTo(range.value); });
    }

    function onPlayerReady(event) {
        playersReadyCount++;
        if(playersReadyCount === 2) {
            updateUI();
            loadDeck(p1, trackIndex);
        }
    }

    // --- UI LOGIC ---

    function setMode(mode) {
        currentMode = mode;
        const container = document.getElementById('main-player-area');
        
        container.classList.remove('mode-video', 'mode-audio');
        container.classList.add('mode-' + mode);
        
        document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('btn-' + mode).classList.add('active');

        updateDeckVisibility();
    }

    function updateDeckVisibility() {
        const w1 = document.getElementById('wrapper1');
        const w2 = document.getElementById('wrapper2');
        
        if (currentDeck === 1) {
            w1.className = 'deck-wrapper deck-active';
            w2.className = 'deck-wrapper deck-bg';
        } else {
            w1.className = 'deck-wrapper deck-bg';
            w2.className = 'deck-wrapper deck-active';
        }
    }

    function renderPlaylist() {
        const list = document.getElementById('playlist-list');
        list.innerHTML = '';

        playlist.forEach((track, index) => {
            const isActive = index === trackIndex ? ' active' : '';
            const thumbUrl = `https://i.ytimg.com/vi/${track.id}/mqdefault.jpg`;
            
            const div = document.createElement('div');
            div.className = `playlist-item${isActive}`;
            
            // –£–ë–†–ê–ù–ê –∫–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è
            div.innerHTML = `
                <div class="playlist-thumb">
                    <img src="${thumbUrl}" loading="lazy">
                </div>
                <div class="playlist-info">
                    <div class="playlist-title">${track.title}</div>
                </div>
            `;
            div.onclick = (e) => {
                jumpToTrack(index);
            };
            list.appendChild(div);
        });
        updateButtons();
    }

    function updatePlayPauseIcon() {
        document.getElementById('icon-play').style.display = isPlaying ? 'none' : 'block';
        document.getElementById('icon-pause').style.display = isPlaying ? 'block' : 'none';
    }

    function updateUI() {
        if(playlist[trackIndex]) {
            const t = playlist[trackIndex];
            document.getElementById('current-track-info').innerText = t.title;
            document.getElementById('cover-overlay').src = `https://i.ytimg.com/vi/${t.id}/maxresdefault.jpg`;
        }
        
        updatePlayPauseIcon();
        updateDeckVisibility();
        updateButtons();
    }

    function updateButtons() {
        document.getElementById('prevBtn').disabled = playlist.length <= 1;
        document.getElementById('nextBtn').disabled = playlist.length <= 1;
    }

    function setMixStatus(isMixing) {
        const container = document.getElementById('meta-info-row');
        if (isMixing) {
            container.innerHTML = `<div class="status-badge">‚ú® MIXING IN PROGRESS...</div>`;
        } else {
            container.innerHTML = `
                <button id="mixBtn" class="btn-mix" onclick="forceCrossfade()">
                    ‚ö° –°–¥–µ–ª–∞—Ç—å Crossfade
                </button>`;
        }
    }

    // --- PLAYER CORE ---

    function togglePlay() {
        if(playersReadyCount < 2) return; 

        let activeP = (currentDeck === 1) ? p1 : p2;
        
        if (!isPlaying) {
            const pState = activeP.getPlayerState();
            if (pState === -1 || pState === 5 || pState === 0) {
                 startMix();
            } else {
                activeP.playVideo();
            }
            // isPlaying = true; // –£–±—Ä–∞–ª–∏, —Ç.–∫. —Ç–µ–ø–µ—Ä—å —ç—Ç–æ –¥–µ–ª–∞–µ—Ç onPlayerStateChange
        } else {
            activeP.pauseVideo();
            // isPlaying = false; // –£–±—Ä–∞–ª–∏, —Ç.–∫. —Ç–µ–ø–µ—Ä—å —ç—Ç–æ –¥–µ–ª–∞–µ—Ç onPlayerStateChange
        }
    }

    function startMix() {
        if(playlist.length === 0) return;
        let activeP = (currentDeck === 1) ? p1 : p2;
        
        activeP.setVolume(100);
        loadDeck(activeP, trackIndex);
        
        activeP.playVideo();
        prepareNext();
        renderPlaylist();
        updateUI();
    }

    function loadDeck(player, idx) {
        if(!playlist[idx]) return;
        player.loadVideoById(playlist[idx].id);
    }

    function prepareNext() {
        if(playlist.length < 2) return;
        let nextP = (currentDeck === 1) ? p2 : p1;
        let nextIndex = (trackIndex + 1) % playlist.length;
        if(playlist[nextIndex]) {
            nextP.cueVideoById(playlist[nextIndex].id);
            nextP.setVolume(0);
        }
    }

    function jumpToTrack(index) {
        if (isCrossfading || index === trackIndex) return;
        trackIndex = index;
        startMix();
        // isPlaying = true; // –£–±—Ä–∞–ª–∏, –ø–æ–ª–∞–≥–∞–µ–º—Å—è –Ω–∞ event
        updateUI();
    }

    function nextTrack() {
        if (isCrossfading || playlist.length < 2) return;
        trackIndex = (trackIndex + 1) % playlist.length;
        startMix();
        // isPlaying = true;
        updateUI();
    }

    function prevTrack() {
        if (isCrossfading || playlist.length < 2) return;
        trackIndex = (trackIndex - 1 + playlist.length) % playlist.length;
        startMix();
        // isPlaying = true;
        updateUI();
    }

    function forceCrossfade() {
        if(!isPlaying || isCrossfading || playlist.length < 2) return;
        performCrossfade();
    }

    // --- TIMER & CROSSFADE ---

    function startLoop() {
        clearInterval(updateTimer);
        updateTimer = setInterval(updatePlayerLoop, 500);
    }

    function updatePlayerLoop() {
        if (!isPlaying) return;

        let activeP = (currentDeck === 1) ? p1 : p2;
        if(!activeP || typeof activeP.getDuration !== 'function') return;

        let duration = activeP.getDuration();
        let current = activeP.getCurrentTime();

        if (!duration || duration <= 0) return;

        if(!isDragging) {
            let pct = (current / duration) * 100;
            document.getElementById('currentTime').innerText = formatTime(current);
            document.getElementById('totalTime').innerText = formatTime(duration);
            document.getElementById('progressBar').value = pct;
        }

        if (!isCrossfading && 
            (duration - current) < CROSSFADE_DURATION && 
            (duration - current) > 0.5 && 
            playlist.length > 1) {
            performCrossfade();
        }
    }

    function performCrossfade() {
        isCrossfading = true;
        setMixStatus(true);
        
        let activeP = (currentDeck === 1) ? p1 : p2;
        let nextP = (currentDeck === 1) ? p2 : p1;

        nextP.playVideo(); 

        let steps = 40;
        let stepTime = (CROSSFADE_DURATION * 1000) / steps;
        let vol = 0;

        let fadeInt = setInterval(() => {
            vol += (100/steps);
            if(vol > 100) vol = 100;

            nextP.setVolume(vol);
            activeP.setVolume(100 - vol);

            if(vol >= 100) {
                clearInterval(fadeInt);
                finishMix(activeP);
            }
        }, stepTime);
    }

    function finishMix(oldP) {
        oldP.stopVideo();
        isCrossfading = false;
        setMixStatus(false);
        
        currentDeck = (currentDeck === 1) ? 2 : 1;
        trackIndex = (trackIndex + 1) % playlist.length;
        
        updateUI(); 
        renderPlaylist();
        prepareNext();
    }

    // --- UTILS ---

    function handleInput() {
        let input = document.getElementById('urlInput');
        let url = input.value.trim();
        if(!url) return;
        
        let listId = extractListId(url);
        if(listId) {
            importPlaylist(listId);
        } else {
            let videoId = extractVideoId(url);
            if(videoId) {
                playlist.push({ id: videoId, title: "–ó–∞–≥—Ä—É–∑–∫–∞..." });
                renderPlaylist();
                input.value = "";
                fetchTitlesForPlaylist();
                if(playlist.length === 1 && !isPlaying) {
                    trackIndex = 0;
                    loadDeck(p1, 0);
                    updateUI();
                }
                updateButtons();
            } else {
                alert("–°—Å—ã–ª–∫–∞ –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–∞");
            }
        }
    }

    function extractVideoId(url) {
        var regExp = /^.*((youtu.be\/)|(v\/)|(\/u\/\w\/)|(embed\/)|(watch\?))\??v?=?([^#&?]*).*/;
        var match = url.match(regExp);
        return (match && match[7].length == 11) ? match[7] : false;
    }
    
    function extractListId(url) {
        let reg = /[?&]list=([^#\&\?]+)/;
        let match = url.match(reg);
        return (match && match[1]) ? match[1] : null;
    }

    function importPlaylist(listId) {
        let scanner = (currentDeck === 1 || !isPlaying) ? p2 : p1;
        if(isPlaying && isCrossfading) { alert("–ü–æ–¥–æ–∂–¥–∏—Ç–µ –∫–æ–Ω—Ü–∞ –ø–µ—Ä–µ—Ö–æ–¥–∞"); return; }
        
        scanner.cuePlaylist({list: listId});
        window.isScanning = true;
        document.getElementById('current-track-info').innerText = "–°–∫–∞–Ω–∏—Ä—É—é –ø–ª–µ–π–ª–∏—Å—Ç...";
    }

    function onPlayerStateChange(event) {
        // --- 1. –õ–û–ì–ò–ö–ê –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–ò –ö–ù–û–ü–ö–ò ---
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –ø—Ä–∏—à–ª–æ –ª–∏ —Å–æ–±—ã—Ç–∏–µ –æ—Ç –ê–ö–¢–ò–í–ù–û–ì–û –ø–ª–µ–µ—Ä–∞
        let activePlayer = (currentDeck === 1) ? p1 : p2;
        
        if (event.target === activePlayer) {
            if (event.data === YT.PlayerState.PLAYING) {
                if (!isPlaying) {
                    isPlaying = true;
                    updatePlayPauseIcon();
                    startLoop(); // –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–∞–π–º–µ—Ä, –µ—Å–ª–∏ —Å—Ç–∞—Ä—Ç –±—ã–ª –Ω–µ —á–µ—Ä–µ–∑ –Ω–∞—à—É –∫–Ω–æ–ø–∫—É
                }
                updatePlayerLoop(); // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π –∞–ø–¥–µ–π—Ç –≤—Ä–µ–º–µ–Ω–∏
            } 
            else if (event.data === YT.PlayerState.PAUSED) {
                if (isPlaying) {
                    isPlaying = false;
                    updatePlayPauseIcon();
                }
            }
            // YT.PlayerState.ENDED (0) –º—ã –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –¥–ª—è –ø–∞—É–∑—ã, 
            // —Ç–∞–∫ –∫–∞–∫ —Ç–∞–º –¥–æ–ª–∂–µ–Ω —Å—Ä–∞–±–æ—Ç–∞—Ç—å Crossfade –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ –∫–æ–Ω–µ—Ü
        }

        // --- 2. –õ–û–ì–ò–ö–ê –°–ö–ê–ù–ò–†–û–í–ê–ù–ò–Ø ---
        if (window.isScanning && event.data === 5) { 
            let ids = event.target.getPlaylist();
            if(ids && ids.length > 0) {
                if(confirm(`–ù–∞–π–¥–µ–Ω–æ ${ids.length} —Ç—Ä–µ–∫–æ–≤. –ó–∞–º–µ–Ω–∏—Ç—å —Å–ø–∏—Å–æ–∫?`)) {
                    playlist = [];
                    trackIndex = 0;
                    currentDeck = 1;
                    p1.stopVideo(); p2.stopVideo();
                    isPlaying = false;
                    updatePlayPauseIcon();
                }
                ids.forEach(vid => playlist.push({ id: vid, title: "Video ID: " + vid }));
                renderPlaylist();
                window.isScanning = false;
                fetchTitlesForPlaylist();
                if(!isPlaying) updateUI();
            }
        }
    }

    async function fetchTitlesForPlaylist() {
        for (let i = 0; i < playlist.length; i++) {
            if (playlist[i].title.startsWith("Video ID") || playlist[i].title === "–ó–∞–≥—Ä—É–∑–∫–∞...") {
                try {
                    const response = await fetch(`https://noembed.com/embed?url=https://www.youtube.com/watch?v=${playlist[i].id}`);
                    const data = await response.json();
                    if (data.title) {
                        playlist[i].title = data.title;
                        renderPlaylist();
                        if(i === trackIndex) updateUI();
                    }
                } catch (e) {}
            }
        }
    }

    function shufflePlaylist() {
        if (playlist.length < 2) return;
        let current = playlist[trackIndex];
        let others = playlist.filter((_, i) => i !== trackIndex);
        for (let i = others.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [others[i], others[j]] = [others[j], others[i]];
        }
        playlist = [current, ...others];
        trackIndex = 0;
        renderPlaylist();
        prepareNext();
    }

    function seekTo(val) {
        let activeP = (currentDeck === 1) ? p1 : p2;
        let dur = activeP.getDuration();
        if(dur > 0) {
            activeP.seekTo(dur * (val / 100), true);
        }
    }

    function formatTime(s) {
        let m = Math.floor(s / 60);
        let sec = Math.floor(s % 60);
        return `${m}:${sec<10?'0':''}${sec}`;
    }
</script>
</body>
</html>
