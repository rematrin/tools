<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>–†–∞—Å–ø—Ä–µ–¥–µ–ª–∏—Ç–µ–ª—å –¥–æ—Ö–æ–¥–∞</title>
<link rel="icon" type="image/png" href="exchange.png">
<link rel="apple-touch-icon" href="exchange2.png">
<style>
  /* === –¶–í–ï–¢–û–í–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï === */
  :root {
    --bg: #f4f6fb;
    --text: #0b0d12;
    --card-bg: #ffffff;
    --border: #e6e9f2;
    --input-bg: transparent;
    --btn-hover: #f0f2f7;
    --accent: #7aa2ff;
    
    /* –°—Ç–∞—Ç—É—Å–Ω—ã–µ —Ü–≤–µ—Ç–∞ */
    --danger: #ff5757;
    --success: #20c767;
    --gray: #a0a0a0;
    
    /* –¶–≤–µ—Ç —Å–∏–º–≤–æ–ª–∞ % –≤ –∏–Ω–ø—É—Ç–µ */
    --input-symbol: #888; 

    /* –¶–≤–µ—Ç–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π */
    --c1: #5475eb;
    
    --tooltip-bg: #2a2c33;
    --tooltip-text: #ffffff;
  }

  body.dark {
    --bg: #0f1115;
    --text: #f3f3f3;
    --card-bg: #1a1d22;
    --border: #292c33;
    --input-bg: transparent;
    --btn-hover: #252830;
    --accent: #5b8af0;
    
    --gray: #6b6b6b;
    --input-symbol: #666; 
    
    --tooltip-bg: #e6e9f2;
    --tooltip-text: #0f1115;
  }

  /* –ò–Ω–≤–µ—Ä—Å–∏—è –∏–∫–æ–Ω–æ–∫ –≤ —Ç–µ–º–Ω–æ–π —Ç–µ–º–µ */
  body.dark img.icon, 
  body.dark .theme-icon { 
      filter: invert(1) brightness(1.3); 
  }
  
  /* –¢–µ–º–Ω–∞—è —Ç–µ–º–∞ –¥–ª—è —à–∞—Ä–∏–Ω–≥–∞ */
  body.dark #copyLink { background: #1b1c21 !important; color: var(--text) !important; border-color: var(--border) !important; }
  body.dark #tgShare { background: #1e2a38 !important; color: var(--text) !important; border-color: var(--border) !important; }
  body.dark #waShare { background: #1f2e22 !important; color: var(--text) !important; border-color: var(--border) !important; }
  body.dark #fbShare { background: #1e2940 !important; color: var(--text) !important; border-color: var(--border) !important; }

  *{box-sizing:border-box}
  
  body {
    font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    margin: 0;
    background: var(--bg);
    color: var(--text);
    transition: background 0.3s ease, color 0.3s ease;
  }

  .wrap {max-width:490px; margin:0 auto; padding:22px 14px 28px}
  
  h1 {font-size:1.25rem; margin:0;}
  
  .topbar {
    display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;
  }
  .topbar-controls { display: flex; gap: 8px; }
  
  .card {display:flex; flex-direction:column; gap:4px; background: var(--bg);}
 
  /* –°–¢–†–û–ö–ò */
  .row {
    display: flex; align-items: center; justify-content: space-between;
    background: var(--card-bg); border: 1px solid var(--border);
    border-radius: 12px; box-shadow: 0 1px 2px rgba(0,0,0,.03);
    padding: 9px 12px; gap: 10px;
    transition: border-color 0.2s, background 0.3s;
  }
  .row:focus-within {
    border-color: var(--accent); box-shadow: 0 0 0 3px rgba(122,162,255,.1);
  }

  .label-group {
    display: flex; align-items: center; gap: 10px; flex-grow: 1; overflow: hidden; 
  }
  .category-name {
    font-weight: 600; font-size: 0.95rem; color: var(--text);
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
  }
  .percent-badge {
    font-size: 0.75rem; font-weight: 700; padding: 2px 6px;
    border-radius: 6px; color: #fff; opacity: 0.9;
    min-width: 36px; text-align: center; flex-shrink: 0;
  }

  /* –ò–ó–ú–ï–ù–ï–ù–ò–ï: –£–º–µ–Ω—å—à–∏–ª —à–∏—Ä–∏–Ω—É —Å 160px –¥–æ 125px */
  .amount { flex-shrink: 0; width: 125px; display: flex; align-items: center; }
  
  .amount input {
    width: 100%; text-align: right; font-size: 1.15rem; padding: 6px 0;
    border: none; background: var(--input-bg); font-family: inherit;
    color: var(--text); font-weight: 500; transition: color 0.2s ease;
  }
  .amount input:focus { outline: none; }
  .amount input::placeholder { color: #ccc; }
  
  /* –ì–õ–ê–í–ù–û–ï –ü–û–õ–ï */
  .row.main-input { margin-bottom: 0px; }
  .row.main-input input { font-weight: 650; color: var(--accent); }

  /* –°–¢–ò–õ–¨ –û–°–¢–ê–¢–ö–ê */
  #val_rest { font-weight: 650; }
  
  #row_rest { 
      transition: border-color 0.3s ease; 
      margin-top: 0px;
  }

  /* –ö–ù–û–ü–ö–ò (–æ–±—â–∏–µ —Å—Ç–∏–ª–∏ –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª–µ–π —Ç–µ–º—ã –∏ —à–∞—Ä–∏–Ω–≥–∞) */
  button {
    background: var(--card-bg); border: 1px solid var(--border); color: var(--text);
    border-radius: 8px; cursor: pointer; transition: all 0.2s ease;
  }
  button:hover { background: var(--btn-hover); }
  button:active { transform: scale(0.95); }

  button#themeToggle, button#shareBtn {
    padding: 6px 10px; display: flex; align-items: center; justify-content: center;
  }
  button img { width: 16px; height: 16px; display: block; pointer-events: none; }

  /* –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–ï */
  .center-controls {
    display: flex; 
    justify-content: center; /* –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ */
    width: 100%;
    margin-top: 18px;
  }
  
  /* –ó–ê–ì–û–õ–û–í–ö–ò –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–Ø */
  .edit-header {
      display: flex; gap: 8px; padding: 0 4px; margin-bottom: 6px;
      font-size: 0.85rem; color: var(--text); font-weight: 600;
  }
  
  /* –°–¢–†–û–ö–ê –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–Ø */
  .edit-row { 
      display: flex; gap: 8px; align-items: flex-start;
      margin-bottom: 5px;
  }
  
  /* –û–ë–ï–†–¢–ö–ê –î–õ–Ø –ù–ê–ó–í–ê–ù–ò–Ø + –û–®–ò–ë–ö–ò */
  .name-wrapper {
      flex: 2; display: flex; flex-direction: column; gap: 4px;
  }
  .edit-input-name {
      width: 100%; border: 1px solid var(--border); border-radius: 8px; padding: 10px;
      background: var(--card-bg); color: var(--text); font-size: 16px;
      transition: border-color 0.2s;
  }
  
  /* –°–¢–ò–õ–ò –û–®–ò–ë–ö–ò */
  .input-error { border-color: var(--danger) !important; }
  .error-text {
      color: var(--danger); font-size: 0.75rem; display: none; padding-left: 2px;
  }
  
  /* –°–¢–ò–õ–¨ –î–õ–Ø –ü–†–û–¶–ï–ù–¢–û–í */
  .percent-wrapper {
      flex: 1; position: relative; display: flex; align-items: center;
  }
  .edit-input-percent {
      width: 100%; border: 1px solid var(--border); border-radius: 8px; 
      padding: 10px 32px 10px 10px;
      background: var(--card-bg); color: var(--text); text-align: right; font-size: 16px;
      -moz-appearance: textfield;
  }
  .edit-input-percent::-webkit-outer-spin-button,
  .edit-input-percent::-webkit-inner-spin-button {
      -webkit-appearance: none; margin: 0;
  }
  .percent-symbol {
      position: absolute; right: 12px; color: var(--input-symbol); 
      pointer-events: none; font-size: 0.9rem; font-weight: 500;
  }

  .del-btn-wrap {
      height: 40px; display: flex; align-items: center;
  }
  .del-btn { background: transparent; border: none; padding: 4px; opacity: 0.6; cursor: pointer; }
  .del-btn:hover { background: transparent; opacity: 1; }
  .del-btn img { width: 14px; height: 14px; }
  
  /* === –î–ï–ô–°–¢–í–ò–Ø (–ö–ù–û–ü–ö–ò –í –†–Ø–î) === */
  .actions-row {
      display: flex;
      width: 100%;
      gap: 10px;
      margin-top: 5px;
      margin-bottom: 10px;
  }

  /* –û–ë–©–ò–ô –°–¢–ò–õ–¨ –î–õ–Ø –ö–ù–û–ü–û–ö –î–ï–ô–°–¢–í–ò–Ø (Add, Save, Edit) */
  .action-btn {
      padding: 10px; 
      background: var(--card-bg); 
      border: 1px solid var(--border); 
      border-radius: 12px; 
      color: var(--accent); /* –°–∏–Ω–∏–π —Ç–µ–∫—Å—Ç */
      font-size: 15px; 
      font-weight: 600;
      display: flex; align-items: center; justify-content: center; 
      gap: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
  }
  .action-btn:hover { 
      border-color: var(--accent);
      background: var(--btn-hover); 
  }
  .action-btn:active {
      transform: scale(0.98);
  }
  /* –ò–∫–æ–Ω–∫–∞ –≤–Ω—É—Ç—Ä–∏ –∫–Ω–æ–ø–∫–∏ –Ω–∞—Å–ª–µ–¥—É–µ—Ç —Ü–≤–µ—Ç —Ç–µ–∫—Å—Ç–∞ */
  .action-btn svg {
      width: 18px; height: 18px; fill: currentColor;
  }

  /* –°–ø–µ—Ü–∏—Ñ–∏–∫–∞ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –≤ —Ä—è–¥ (–î–æ–±–∞–≤–∏—Ç—å / –°–æ—Ö—Ä–∞–Ω–∏—Ç—å) */
  .actions-row .action-btn {
      flex: 1; 
  }

  /* –°–ø–µ—Ü–∏—Ñ–∏–∫–∞ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –ù–∞—Å—Ç—Ä–æ–µ–∫ */
  #editBtn {
      width: 50%; /* –ó–∞–Ω–∏–º–∞–µ—Ç 50% —à–∏—Ä–∏–Ω—ã */
      min-width: 200px; /* –ù–æ –Ω–µ –º–µ–Ω—å—à–µ 200px –Ω–∞ –º–æ–±–∏–ª–∫–∞—Ö */
  }

  .divider {
      height: 1px;
      margin: 10px auto;
      width: 95%;
      border: none;
      background: radial-gradient(ellipse at center, var(--text) 0%, transparent 70%);
      opacity: 0.15;
  }
  /* ========================================= */

  /* POPUP */
  #sharePopup {
    position: absolute; display: none; background: var(--card-bg); border: 1px solid var(--border); padding: 10px;
    border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.15); flex-direction: column; gap: 8px; z-index: 100; width: 190px;
    animation: fadeIn .2s ease; color: var(--text);
  }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(-4px); } to { opacity: 1; transform: translateY(0); } }
  .share-item {
    display: flex; align-items: center; gap: 10px; padding: 8px; border-radius: 8px; text-decoration: none;
    color: var(--text); font-size: 0.9rem; cursor: pointer; transition: background 0.2s; background: transparent; border: none; width: 100%; text-align: left;
  }
  #copyLink { background: #f5f5f5; color: var(--text); }
  #tgShare { background: #e3f2fd; color: var(--text); }
  #waShare { background: #e8f5e9; color: var(--text); }
  #fbShare { background: #e3f2fd; color: var(--text); }

  /* TOOLTIP */
  #customTooltip {
    position: fixed; background: var(--tooltip-bg); color: var(--tooltip-text); padding: 6px 12px; border-radius: 6px;
    font-size: 0.8rem; pointer-events: none; opacity: 0; transform: translateY(5px); transition: opacity 0.2s, transform 0.2s;
    z-index: 1000; box-shadow: 0 4px 12px rgba(0,0,0,0.15); white-space: nowrap; font-weight: 500;
  }
  #customTooltip.visible { opacity: 1; transform: translateY(0); }

</style>
      <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-384FKZ1NQP"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-384FKZ1NQP');
</script>
</head>
<body>

<div id="customTooltip"></div>

<div class="wrap">

  <div class="topbar">
    <h1>–†–∞—Å–ø—Ä–µ–¥–µ–ª–∏—Ç–µ–ª—å</h1>
    <div class="topbar-controls">
        <button id="themeToggle" data-tip="–°–º–µ–Ω–∏—Ç—å —Ç–µ–º—É">
            <img class="theme-icon" src="https://cdn-icons-png.flaticon.com/128/4489/4489231.png" alt="Theme">
        </button>
        <button id="shareBtn" data-tip="–ü–æ–¥–µ–ª–∏—Ç—å—Å—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏">
            <img class="icon" src="https://cdn-icons-png.flaticon.com/512/1828/1828954.png" alt="Share">
        </button>
    </div>
  </div>

  <div id="viewContainer">
      <div class="row main-input">
          <div class="label-group">
              <span class="category-name">–î–æ—Ö–æ–¥</span>
          </div>
          <div class="amount">
              <input type="text" id="totalIncome" inputmode="decimal" placeholder="0" autocomplete="off" autofocus>
          </div>
      </div>
      
      <div class="divider"></div>

      <div class="card" id="resultsView">
      </div>
  </div>

  <div class="card" id="editView" style="display:none; margin-top:10px;">
  </div>

  <div class="center-controls">
      <button id="editBtn" class="action-btn">
          <svg viewBox="0 0 24 24"><path d="M19.14,12.94c0.04-0.3,0.06-0.61,0.06-0.94c0-0.32-0.02-0.64-0.06-0.94l2.03-1.58c0.18-0.14,0.23-0.41,0.12-0.61 l-1.92-3.32c-0.12-0.22-0.37-0.29-0.59-0.22l-2.39,0.96c-0.5-0.38-1.03-0.7-1.62-0.94L14.4,2.81c-0.04-0.24-0.24-0.41-0.48-0.41 h-3.84c-0.24,0-0.43,0.17-0.47,0.41L9.25,5.35C8.66,5.59,8.12,5.92,7.63,6.29L5.24,5.33c-0.22-0.08-0.47,0-0.59,0.22L2.74,8.87 C2.62,9.08,2.66,9.34,2.86,9.49l2.03,1.58C4.84,11.36,4.8,11.69,4.8,12s0.02,0.64,0.06,0.94l-2.03,1.58 c-0.18,0.14-0.23,0.41-0.12,0.61l1.92,3.32c0.12,0.22,0.37,0.29,0.59,0.22l2.39-0.96c0.5,0.38,1.03,0.7,1.62,0.94l0.36,2.54 c0.05,0.24,0.24,0.41,0.48,0.41h3.84c0.24,0,0.43-0.17,0.47-0.41l0.36-2.54c0.59-0.24,1.13-0.56,1.62-0.94l2.39,0.96 c0.22,0.08,0.47,0,0.59-0.22l1.92-3.32c0.12-0.22,0.07-0.47-0.12-0.61L19.14,12.94z M12,15.6c-1.98,0-3.6-1.62-3.6-3.6 s1.62-3.6,3.6-3.6s3.6,1.62,3.6,3.6S13.98,15.6,12,15.6z"/></svg>
          –ö–∞—Ç–µ–≥–æ—Ä–∏–∏
      </button>
  </div>

  <div id="sharePopup">
    <button id="copyLink" class="share-item">
      <img class="icon" src="https://cdn-icons-png.flaticon.com/512/7640/7640062.png" width="18" height="18" alt=""> 
      –°—Å—ã–ª–∫–∞
    </button>
    <a id="tgShare" target="_blank" class="share-item">
      <img src="https://cdn-icons-png.flaticon.com/512/2111/2111646.png" width="18" height="18" alt=""> 
      Telegram
    </a>
    <a id="waShare" target="_blank" class="share-item">
      <img src="https://cdn-icons-png.flaticon.com/512/2111/2111728.png" width="18" height="18" alt=""> 
      WhatsApp
    </a>
    <a id="fbShare" target="_blank" class="share-item">
      <img src="https://cdn-icons-png.flaticon.com/512/733/733547.png" width="18" height="18" alt=""> 
      Facebook
    </a>
  </div>

</div>

<script>
const PALETTE = [
    'var(--c1)'
];

const DEFAULT_CATEGORIES = [
    { name: 'üè¶ –ù–∞–ª–æ–≥–∏',     percent: 15 },
    { name: 'üí∞ –†–µ–∑–µ—Ä–≤', percent: 10 },
    { name: 'üìà –ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏',      percent: 12 },
  { name: 'üè† –ê—Ä–µ–Ω–¥–∞',      percent: 20 },
  { name: 'üí≠ –ú–µ—á—Ç—ã',      percent: 5 },
];

let categories = [];

// === –≠–õ–ï–ú–ï–ù–¢–´ ===
const totalInput = document.getElementById('totalIncome');
const viewContainer = document.getElementById('viewContainer');
const resultsView = document.getElementById('resultsView');
const editView = document.getElementById('editView');
const editBtn = document.getElementById('editBtn');

// === INIT ===
const params = new URLSearchParams(location.search);

function init() {
    if (params.get('amount')) {
        totalInput.value = formatInputString(params.get('amount'));
    }

    const catsParam = params.get('cats');
    if (catsParam) {
        try {
            categories = decodeURIComponent(catsParam).split('|').map(item => {
                const [name, p] = item.split(':');
                return { name: name, percent: Number(p) };
            });
        } catch (e) { categories = [...DEFAULT_CATEGORIES]; }
    } else {
        categories = [...DEFAULT_CATEGORIES];
    }

    renderViewMode();
    calculate();
}

function updateURL() {
    const catsStr = categories.map(c => `${c.name}:${c.percent}`).join('|');
    const newParams = new URLSearchParams();
    newParams.set('cats', encodeURIComponent(catsStr));
    history.replaceState(null, '', location.pathname + '?' + newParams.toString());
}

// === –†–ï–ù–î–ï–†–ò–ù–ì (–ü–†–û–°–ú–û–¢–†) ===
function renderViewMode() {
    resultsView.innerHTML = '';
    
    // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π
    categories.forEach((cat, index) => {
        const color = PALETTE[index % PALETTE.length];
        createResultRow(index, cat.name, cat.percent, color);
    });

    // –î–û–ë–ê–í–õ–ï–ù–ò–ï –†–ê–ó–î–ï–õ–ò–¢–ï–õ–Ø –ú–ï–ñ–î–£ –ö–ê–¢–ï–ì–û–†–ò–Ø–ú–ò –ò –û–°–¢–ê–¢–ö–û–ú
    if (categories.length > 0) {
        const div = document.createElement('div');
        div.className = 'divider';
        resultsView.appendChild(div);
    }

    // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –æ—Å—Ç–∞—Ç–∫–∞
    createResultRow('rest', '–û—Å—Ç–∞—Ç–æ–∫', 0, 'var(--gray)', true); 
    updateRestStyle();
}

function createResultRow(id, name, percent, color, isReadonly = false) {
    const percentDisplay = parseFloat(percent.toFixed(1)); 

    const row = document.createElement('div');
    row.className = 'row';
    if(id === 'rest') row.id = 'row_rest';
    
    // –ò–∑–Ω–∞—á–∞–ª—å–Ω–æ —Å—Ç–∞–≤–∏–º readonly –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–π, calculate() —ç—Ç–æ –∏—Å–ø—Ä–∞–≤–∏—Ç –µ—Å–ª–∏ –Ω–∞–¥–æ
    const initialReadonly = isReadonly || false; 

    row.innerHTML = `
        <div class="label-group">
            <span class="category-name">${name}</span>
            <span class="percent-badge" id="badge_${id}" style="background:${color}">${percentDisplay}%</span>
        </div>
        <div class="amount">
            <input type="text" id="val_${id}" inputmode="decimal" placeholder="0" autocomplete="off" ${initialReadonly ? 'readonly' : ''}>
        </div>
    `;
    
    if (!isReadonly) {
        const input = row.querySelector('input');
        input.addEventListener('keydown', validateInputKey);
        input.addEventListener('input', (e) => {
            formatInputLive(e.target);
            const total = parseRaw(totalInput.value);
            
            if (total <= 0) {
                e.target.value = ''; 
                return;
            }

            const currentVal = parseRaw(e.target.value);
            const newPercent = (currentVal / total) * 100;
            categories[id].percent = newPercent;
            
            const badge = document.getElementById(`badge_${id}`);
            if (badge) badge.innerText = parseFloat(newPercent.toFixed(1)) + '%';
            
            recalculateRestOnly(total);
            updateURL();
        });
    }
    resultsView.appendChild(row);
}

// === –í–ê–õ–ò–î–ê–¶–ò–Ø ===
function validateInputKey(e) {
    const allowed = ['Backspace', 'ArrowLeft', 'ArrowRight', 'Delete', 'Tab', 'Enter', 'a', 'c', 'v', 'x']; 
    if (allowed.includes(e.key) || e.ctrlKey || e.metaKey) return;
    if (!/[\d.,]/.test(e.key)) {
        e.preventDefault();
    }
}

// === –õ–û–ì–ò–ö–ê –†–ê–°–ß–ï–¢–ê ===
function calculate() {
    const rawVal = totalInput.value;
    const total = parseRaw(rawVal);
    const hasIncome = total > 0;
    
    // –õ–û–ì–ò–ö–ê –ë–õ–û–ö–ò–†–û–í–ö–ò –ü–û–õ–ï–ô (Fix #2)
    categories.forEach((_, i) => {
        const el = document.getElementById(`val_${i}`);
        if(el) {
            if(hasIncome) {
                el.removeAttribute('readonly');
            } else {
                el.setAttribute('readonly', 'true');
                el.value = ''; // –û—á–∏—â–∞–µ–º, –µ—Å–ª–∏ –¥–æ—Ö–æ–¥–∞ –Ω–µ—Ç
            }
        }
    });

    if (rawVal.trim() === '') {
        const restEl = document.getElementById('val_rest');
        if(restEl) restEl.value = '';
        updateRestStyle();
        return;
    }

    let runningTotal = 0;
    categories.forEach((cat, i) => {
        const amount = total * (cat.percent / 100);
        runningTotal += amount;
        const el = document.getElementById(`val_${i}`);
        if(el && document.activeElement !== el) { // –ù–µ –æ–±–Ω–æ–≤–ª—è–µ–º, –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ç–∞–º –ø–∏—à–µ—Ç
             el.value = formatPretty(amount);
        }
    });

    const rest = total - runningTotal;
    const restEl = document.getElementById('val_rest');
    if(restEl) restEl.value = formatPretty(rest);
    
    updateRestStyle();
    updateURL();
}

function recalculateRestOnly(total) {
    let runningTotal = 0;
    categories.forEach(cat => {
        runningTotal += total * (cat.percent / 100);
    });
    
    const rest = total - runningTotal;
    const restEl = document.getElementById('val_rest');
    if(restEl) restEl.value = formatPretty(rest);
    
    updateRestStyle();
}

// === –°–¢–ò–õ–¨ –û–°–¢–ê–¢–ö–ê ===
function updateRestStyle() {
    const usedPercent = categories.reduce((sum, c) => sum + c.percent, 0);
    const restPercent = 100 - usedPercent;
    
    const roundedRest = parseFloat(restPercent.toFixed(1));

    let color;
    if (roundedRest === 0) {
        color = 'var(--gray)';
    } else if (roundedRest > 0) {
        color = 'var(--success)'; 
    } else {
        color = 'var(--danger)';
    }
    
    const restBadge = document.getElementById('badge_rest');
    if (restBadge) {
        restBadge.innerText = roundedRest + '%';
        restBadge.style.background = color;
    }
    
    const restInput = document.getElementById('val_rest');
    if (restInput) restInput.style.color = color;
}

// === –†–ï–ù–î–ï–†–ò–ù–ì (–†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–ï) ===
function renderEditMode() {
    editView.innerHTML = '';
    
    // –ó–ê–ì–û–õ–û–í–ö–ò
    const headerDiv = document.createElement('div');
    headerDiv.className = 'edit-header';
    headerDiv.innerHTML = `
        <span style="flex:2">–ù–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</span>
        <span style="flex:1; padding-right:10px; text-align:right">–ü—Ä–æ—Ü–µ–Ω—Ç</span>
        <span style="width:22px"></span> 
    `;
    editView.appendChild(headerDiv);

    categories.forEach((cat, index) => {
        const div = document.createElement('div');
        div.className = 'edit-row';
        div.innerHTML = `
            <div class="name-wrapper">
                <input type="text" class="edit-input-name" value="${cat.name}" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ" autocomplete="off">
                <span class="error-text">–ü–æ–ª–µ –Ω–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –ø—É—Å—Ç—ã–º</span>
            </div>
            <div class="percent-wrapper">
                <input type="number" class="edit-input-percent" value="${parseFloat(cat.percent.toFixed(1))}" placeholder="0" autocomplete="off">
                <span class="percent-symbol">%</span>
            </div>
            <div class="del-btn-wrap">
                <button class="del-btn" onclick="removeCategory(${index})" data-tip="–£–¥–∞–ª–∏—Ç—å">
                    <img class="icon" src="https://cdn-icons-png.flaticon.com/512/1828/1828778.png" alt="x">
                </button>
            </div>
        `;
        
        const nInput = div.querySelector('.edit-input-name');
        const errText = div.querySelector('.error-text');
        nInput.addEventListener('input', () => {
             nInput.classList.remove('input-error');
             errText.style.display = 'none';
        });

        const pInput = div.querySelector('.edit-input-percent');
        pInput.addEventListener('keydown', (e) => { if (e.key === '-' || e.key === '+') e.preventDefault(); });
        pInput.addEventListener('input', function() {
            let v = parseFloat(this.value);
            if (v < 0) this.value = 0;
        });
        
        editView.appendChild(div);
    });

    // –ö–û–ù–¢–ï–ô–ù–ï–† –î–õ–Ø –î–í–£–• –ö–ù–û–ü–û–ö
    const actionsRow = document.createElement('div');
    actionsRow.className = 'actions-row';

    // –ö–ù–û–ü–ö–ê –î–û–ë–ê–í–ò–¢–¨
    const addBtn = document.createElement('button');
    addBtn.className = 'action-btn';
    addBtn.innerHTML = `
        <svg viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
        –î–æ–±–∞–≤–∏—Ç—å
    `;
    addBtn.onclick = addCategory;
    actionsRow.appendChild(addBtn);

    // –ö–ù–û–ü–ö–ê –°–û–•–†–ê–ù–ò–¢–¨
    const saveBtn = document.createElement('button');
    saveBtn.className = 'action-btn';
    saveBtn.innerHTML = `
        <svg viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>
        –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
    `;
    saveBtn.onclick = saveCategories;
    actionsRow.appendChild(saveBtn);

    editView.appendChild(actionsRow);
}

function addCategory() {
    saveCurrentEditState(); 
    categories.push({ name: '', percent: 0 });
    renderEditMode();
}

function removeCategory(index) {
    saveCurrentEditState();
    categories.splice(index, 1);
    renderEditMode();
}

function saveCurrentEditState() {
    const rows = editView.querySelectorAll('.edit-row');
    const newCats = [];
    rows.forEach(row => {
        const name = row.querySelector('.edit-input-name').value;
        let percent = Number(row.querySelector('.edit-input-percent').value);
        if (percent < 0) percent = 0;
        newCats.push({ name, percent });
    });
    categories = newCats;
}

// === –§–£–ù–ö–¶–ò–Ø –°–û–•–†–ê–ù–ï–ù–ò–Ø ===
function saveCategories() {
    let hasError = false;
    const rows = editView.querySelectorAll('.edit-row');
    
    rows.forEach(row => {
        const nameInput = row.querySelector('.edit-input-name');
        const errText = row.querySelector('.error-text');
        
        if (nameInput.value.trim() === '') {
            nameInput.classList.add('input-error');
            errText.style.display = 'block';
            hasError = true;
        } else {
            nameInput.classList.remove('input-error');
            errText.style.display = 'none';
        }
    });
    
    if (hasError) return;

    saveCurrentEditState();
    
    renderViewMode();
    calculate();
    editView.style.display = 'none';
    viewContainer.style.display = 'block';
    editBtn.style.display = 'flex'; // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –Ω–∞—Å—Ç—Ä–æ–µ–∫
    updateURL();
}

// === –£–ü–†–ê–í–õ–ï–ù–ò–ï –†–ï–ñ–ò–ú–ê–ú–ò ===
editBtn.onclick = () => {
    renderEditMode();
    viewContainer.style.display = 'none';
    editView.style.display = 'flex';
    editBtn.style.display = 'none';
};

// === –ß–ò–°–õ–û–í–´–ï –§–£–ù–ö–¶–ò–ò ===
function parseRaw(str) {
    if(!str) return 0;
    return parseFloat(str.replace(/\s/g, '').replace(',', '.')) || 0;
}
function formatPretty(num) {
    if (num === 0) return ''; 
    return num.toLocaleString('ru-RU', { maximumFractionDigits: 2, minimumFractionDigits: 0 });
}
function formatInputString(str) {
    const num = parseRaw(str);
    if (num === 0) return '';
    return num.toLocaleString('ru-RU');
}
function formatInputLive(input) {
    let raw = input.value;
    if (!raw) return;
    const cursor = input.selectionStart;
    let meaningfulCharsBeforeCursor = 0;
    for (let i = 0; i < cursor; i++) if (/[\d.,]/.test(raw[i])) meaningfulCharsBeforeCursor++;
    let clean = raw.replace(/\s/g, '').replace('.', ','); 
    let parts = clean.split(',');
    let integerPart = parts[0];
    let decimalPart = parts.length > 1 ? parts.slice(1).join('') : null;
    let formattedInt = '';
    if (integerPart !== '') {
        if (!isNaN(parseInt(integerPart))) formattedInt = parseInt(integerPart).toLocaleString('ru-RU');
        else formattedInt = integerPart;
    }
    let newVal = formattedInt;
    if (decimalPart !== null) newVal += ',' + decimalPart;
    else if (clean.includes(',')) newVal += ',';
    if (input.value !== newVal) {
        input.value = newVal;
        let newCursor = 0;
        let count = 0;
        for (let i = 0; i < newVal.length; i++) {
            if (count === meaningfulCharsBeforeCursor) break;
            if (/[\d.,]/.test(newVal[i])) count++;
            newCursor++;
        }
        input.setSelectionRange(newCursor, newCursor);
    }
}

totalInput.addEventListener('keydown', validateInputKey);
totalInput.addEventListener('input', (e) => {
    formatInputLive(e.target);
    calculate();
});

// === –ü–û–î–ï–õ–ò–¢–¨–°–Ø ===
const shareBtn = document.getElementById('shareBtn');
const popup = document.getElementById('sharePopup');
const copyLink = document.getElementById('copyLink');
const tg = document.getElementById('tgShare');
const wa = document.getElementById('waShare');
const fb = document.getElementById('fbShare');

async function shorten(url) {
  try {
    const r = await fetch(`https://is.gd/create.php?format=json&url=${encodeURIComponent(url)}`);
    const data = await r.json();
    return data.shorturl || url;
  } catch (e) { return url; }
}

async function showSharePopup() {
  let longUrl = window.location.href;
  let shortUrl = await shorten(longUrl);
  tg.href = `https://t.me/share/url?url=${encodeURIComponent(shortUrl)}`;
  wa.href = `https://api.whatsapp.com/send?text=${encodeURIComponent(shortUrl)}`;
  fb.href = `https://www.facebook.com/share_channel/?type=reshare&link=${encodeURIComponent(shortUrl)}&app_id=87741124305&source_surface=external_reshare&display=popup`;
  copyLink.onclick = () => {
    navigator.clipboard.writeText(shortUrl);
    const originalHTML = copyLink.innerHTML;
    copyLink.innerHTML = `<span style="margin:0 auto">–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!</span>`;
    setTimeout(() => copyLink.innerHTML = originalHTML, 2000);
  };
  popup.style.display = 'flex';
  const r = shareBtn.getBoundingClientRect();
  popup.style.left = (r.left + r.width/2 - popup.offsetWidth/2) + 'px';
  popup.style.top = (r.bottom + 8) + 'px';
  if (r.left + popup.offsetWidth > window.innerWidth) popup.style.left = (window.innerWidth - popup.offsetWidth - 8) + 'px';
}
shareBtn.onclick = (e) => {
  e.stopPropagation();
  if (popup.style.display === 'flex') popup.style.display = 'none';
  else showSharePopup();
};
document.addEventListener('click', e => {
  if (!popup.contains(e.target) && e.target !== shareBtn) popup.style.display = 'none';
});

// === THEME & TOOLTIPS (FIX #1: –û—Ç–∫–ª—é—á–∞–µ–º —Ç—É–ª—Ç–∏–ø—ã –Ω–∞ —Ç–∞—á-—É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö) ===
const savedTheme = localStorage.getItem('theme');
const prefersDark = window.matchMedia('(prefers-color-scheme: dark)');
function applyTheme(theme) {
  if (theme === 'dark') document.body.classList.add('dark');
  else document.body.classList.remove('dark');
}
if (savedTheme) applyTheme(savedTheme);
else applyTheme(prefersDark.matches ? 'dark' : 'light');
document.getElementById('themeToggle').onclick = () => {
  const isDark = document.body.classList.toggle('dark');
  localStorage.setItem('theme', isDark ? 'dark' : 'light');
};

const tooltipEl = document.getElementById('customTooltip');
function showTooltip(el) {
  // –ü–†–û–í–ï–†–ö–ê: –ï—Å–ª–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç hover (—Ç–µ–ª–µ—Ñ–æ–Ω), –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º
  if (!window.matchMedia('(hover: hover)').matches) return;

  const text = el.getAttribute('data-tip');
  if (!text) return;
  const rect = el.getBoundingClientRect();
  tooltipEl.textContent = text;
  tooltipEl.classList.add('visible');
  let top = rect.bottom + 8;
  let left = rect.left + (rect.width/2) - (tooltipEl.offsetWidth/2);
  if (left < 10) left = 10;
  if (left + tooltipEl.offsetWidth > window.innerWidth) left = window.innerWidth - tooltipEl.offsetWidth - 10;
  tooltipEl.style.top = `${top}px`;
  tooltipEl.style.left = `${left}px`;
}

document.body.addEventListener('mouseover', (e) => {
    const target = e.target.closest('[data-tip]');
    if (target) showTooltip(target);
});
document.body.addEventListener('mouseout', (e) => {
    const target = e.target.closest('[data-tip]');
    if (target) tooltipEl.classList.remove('visible');
});
document.body.addEventListener('click', (e) => {
    const target = e.target.closest('[data-tip]');
    if (target) tooltipEl.classList.remove('visible');
});

init();
</script>
    <link rel="stylesheet" href="footer.css">
<div id="footer"></div>
<script>
fetch('footer.html')
  .then(r => r.text())
  .then(html => document.getElementById('footer').innerHTML = html);
</script>
</body>
</html>
