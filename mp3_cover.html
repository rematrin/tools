<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Скачать обложки из MP3 (Мультизагрузка)</title>
<link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/3750/3750547.png">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jsmediatags/3.9.5/jsmediatags.min.js"></script>

<link rel="stylesheet" href="theme.css">

<style>
  /* === ЛОКАЛЬНЫЕ СТИЛИ === */
  :root {
    --input-bg: var(--card-bg);
    --btn-hover: var(--hover-bg);
    --gray: #999;
    --danger: #ff5757;
  }

  body.dark {
    --input-bg: var(--card-bg); 
    --gray: #6b6b6b;
  }

  body.dark .theme-icon {
      filter: invert(1) brightness(1.3);
  }

  /* Общий контейнер расширен для сетки */
  .wrap { max-width: 800px; margin: 0 auto; padding: 22px 14px 28px; }
  
  /* ШАПКА */
  .topbar {
    display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;
  }
  h1 { font-size:1.25rem; margin:0; color: var(--text); }
  
  .topbar-controls { display: flex; gap: 8px; align-items: center; }

  /* --- КАРТОЧКА --- */
  .card {
    background: var(--card-bg);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 12px;
    margin-bottom: 12px;
    box-shadow: 0 1px 2px rgba(0,0,0,.03);
    position: relative; 
    transition: background 0.3s ease, border-color 0.3s ease;
  }

  /* ЗОНА ЗАГРУЗКИ */
  .drop-zone {
      border: 2px dashed var(--border);
      border-radius: 12px;
      padding: 40px 20px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s ease;
      background: var(--bg);
      display: flex; flex-direction: column; align-items: center; gap: 10px;
  }
  
  .drop-zone:hover, .drop-zone.dragover {
      border-color: var(--accent);
      background: var(--btn-hover);
  }
  
  .drop-zone.error {
      border-color: var(--danger);
      background: rgba(255, 87, 87, 0.05);
  }
  
  @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-4px); }
      75% { transform: translateX(4px); }
  }
  .shake { animation: shake 0.3s ease-in-out; }

  .drop-zone svg {
      width: 48px; height: 48px; fill: var(--accent); opacity: 0.8;
  }
  .drop-zone.error svg { fill: var(--danger); }

  .drop-zone span {
      font-size: 0.95rem; color: var(--text-secondary); font-weight: 500;
  }
  .drop-zone input { display: none; }

  .error-message {
      color: var(--danger); font-size: 0.9rem; text-align: center; margin-top: 5px; display: none; 
  }
  .error-message.visible { display: block; animation: fadeInErr 0.2s ease forwards; }
  @keyframes fadeInErr { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }

  /* === СЕТКА РЕЗУЛЬТАТОВ === */
  #resultsGrid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap: 12px;
      margin-top: 20px;
  }

  /* Карточка отдельного трека в сетке */
  .track-card {
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px;
      display: flex; flex-direction: column; align-items: center; text-align: center;
      position: relative;
      animation: popIn 0.3s ease forwards;
  }

  @keyframes popIn {
      from { opacity: 0; transform: scale(0.9); }
      to { opacity: 1; transform: scale(1); }
  }

  .cover-preview {
      width: 100%; aspect-ratio: 1/1;
      border-radius: 8px; object-fit: cover;
      background: #eee; margin-bottom: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  }

  .track-info { width: 100%; margin-bottom: 10px; }
  .track-title { font-weight: 700; font-size: 0.95rem; color: var(--text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .track-artist { color: var(--text-secondary); font-size: 0.85rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

  /* КНОПКИ */
  .btn-download {
      padding: 6px 12px;
      background: var(--card-bg); border: 1px solid var(--border); border-radius: 6px;
      color: var(--accent); font-size: 0.85rem; font-weight: 600; cursor: pointer;
      display: flex; align-items: center; justify-content: center; gap: 6px;
      width: 100%; transition: all 0.2s;
  }
  .btn-download:hover { background: var(--btn-hover); border-color: var(--accent); }
  .btn-download svg { width: 14px; height: 14px; fill: currentColor; }

  .close-card-btn {
      position: absolute; top: 5px; right: 5px;
      background: rgba(0,0,0,0.5); border: none; border-radius: 50%;
      cursor: pointer; color: #fff;
      width: 24px; height: 24px; display: flex; align-items: center; justify-content: center;
      transition: background 0.2s; z-index: 2;
  }
  .close-card-btn:hover { background: var(--danger); }
  .close-card-btn svg { width: 14px; height: 14px; fill: currentColor; }

  /* Верхние контролы результатов */
  .results-controls {
      display: none; justify-content: space-between; align-items: center; margin-bottom: 10px;
  }
  .btn-clear {
      background: none; border: none; color: var(--text-secondary); cursor: pointer; font-size: 0.9rem;
  }
  .btn-clear:hover { color: var(--danger); text-decoration: underline; }

  /* Tooltip */
  #customTooltip {
    position: fixed; background: var(--tooltip-bg); color: var(--tooltip-text); padding: 6px 12px; border-radius: 6px;
    font-size: 0.8rem; pointer-events: none; opacity: 0; z-index: 1000; box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    white-space: nowrap; font-weight: 500; transition: opacity 0.2s;
  }
  #customTooltip.visible { opacity: 1; }

</style>
  
<script async src="https://www.googletagmanager.com/gtag/js?id=G-384FKZ1NQP"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-384FKZ1NQP');
</script>
</head>
<body>

<script src="theme-loader.js"></script>

<div id="header-container"></div>
<div id="customTooltip"></div>

<div class="wrap">
  <div class="topbar">
      <h1>Скачать обложки</h1>
      <div class="topbar-controls"></div>
  </div>

  <div class="card" id="uploadCard">
    <label class="drop-zone" id="dropZone">
        <input type="file" id="fileInput" accept="audio/mpeg, audio/mp3" multiple>
        <svg viewBox="0 0 24 24"><path d="M9 16h6v-6h4l-7-7-7 7h4zm-4 2h14v2H5z"/></svg>
        <span>Нажмите или перетащите MP3 файлы сюда</span>
    </label>
    <div id="errorMsg" class="error-message"></div>
  </div>

  <div class="results-controls" id="resultsControls">
      <span style="color: var(--text-secondary); font-size: 0.9rem;">Найдено файлов: <b id="countVal">0</b></span>
      <button class="btn-clear" id="clearAllBtn">Очистить все</button>
  </div>

  <div id="resultsGrid"></div>

</div>

<script>
// --- ЭЛЕМЕНТЫ DOM ---
const fileInput = document.getElementById('fileInput');
const dropZone = document.getElementById('dropZone');
const errorMsg = document.getElementById('errorMsg');
const resultsGrid = document.getElementById('resultsGrid');
const resultsControls = document.getElementById('resultsControls');
const countVal = document.getElementById('countVal');
const clearAllBtn = document.getElementById('clearAllBtn');

// Функция показа ошибки
function showError(text) {
    dropZone.classList.add('error');
    dropZone.classList.add('shake');
    errorMsg.textContent = text;
    errorMsg.classList.add('visible'); 
    setTimeout(() => { dropZone.classList.remove('shake'); }, 300);
}

function hideError() {
    dropZone.classList.remove('error');
    errorMsg.classList.remove('visible'); 
}

// Обработчики событий Drag & Drop
dropZone.addEventListener('dragover', (e) => {
    e.preventDefault();
    hideError();
    dropZone.classList.add('dragover');
});
dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
dropZone.addEventListener('drop', (e) => {
    e.preventDefault();
    dropZone.classList.remove('dragover');
    if (e.dataTransfer.files.length > 0) handleFiles(e.dataTransfer.files);
});

// Клик по input
fileInput.addEventListener('click', hideError); 
fileInput.addEventListener('change', (e) => {
    hideError();
    if (e.target.files.length > 0) handleFiles(e.target.files);
});

// Очистка всех результатов
clearAllBtn.addEventListener('click', () => {
    resultsGrid.innerHTML = '';
    updateUIState();
    fileInput.value = ''; // Сброс инпута
});

// --- ОСНОВНАЯ ЛОГИКА ---

function handleFiles(files) {
    // Преобразуем FileList в массив
    Array.from(files).forEach(file => {
        if (!file.type.includes('audio') && !file.name.toLowerCase().endsWith('.mp3')) {
            // Пропускаем не-mp3 файлы, но не останавливаем остальные
            return;
        }
        processFile(file);
    });
}

function updateUIState() {
    const cards = resultsGrid.children.length;
    countVal.innerText = cards;
    if (cards > 0) {
        resultsControls.style.display = 'flex';
    } else {
        resultsControls.style.display = 'none';
    }
}

function processFile(file) {
    // 1. Создаем каркас карточки
    const cardId = 'card_' + Math.random().toString(36).substr(2, 9);
    
    const cardHTML = document.createElement('div');
    cardHTML.className = 'track-card';
    cardHTML.id = cardId;
    
    // Структура карточки (изначально загрузка)
    cardHTML.innerHTML = `
        <button class="close-card-btn" onclick="removeCard('${cardId}')" title="Удалить">
             <svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
        <img class="cover-preview" src="https://cdn-icons-png.flaticon.com/512/1477/1477009.png" alt="Loading...">
        <div class="track-info">
            <div class="track-title">Загрузка...</div>
            <div class="track-artist">${file.name}</div>
        </div>
        <button class="btn-download" disabled>
            ...
        </button>
    `;
    
    // Добавляем в начало сетки
    resultsGrid.insertBefore(cardHTML, resultsGrid.firstChild);
    updateUIState();

    // 2. Читаем теги
    window.jsmediatags.read(file, {
        onSuccess: function(tag) {
            const tags = tag.tags;
            const title = tags.title || file.name;
            const artist = tags.artist || "Неизвестный";
            
            let imageUrl = "https://cdn-icons-png.flaticon.com/512/3844/3844724.png"; // Заглушка
            let hasCover = false;

            if (tags.picture) {
                const { data, format } = tags.picture;
                let base64String = "";
                for (let i = 0; i < data.length; i++) {
                    base64String += String.fromCharCode(data[i]);
                }
                imageUrl = `data:${format};base64,${window.btoa(base64String)}`;
                hasCover = true;
            }

            // Обновляем карточку
            const imgEl = cardHTML.querySelector('.cover-preview');
            const titleEl = cardHTML.querySelector('.track-title');
            const artistEl = cardHTML.querySelector('.track-artist');
            const btnEl = cardHTML.querySelector('.btn-download');

            imgEl.src = imageUrl;
            titleEl.innerText = title;
            titleEl.title = title; // tooltip browser
            artistEl.innerText = artist;
            artistEl.title = artist;

            if (hasCover) {
                btnEl.disabled = false;
                btnEl.innerHTML = `<svg viewBox="0 0 24 24"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg> Скачать`;
                btnEl.onclick = () => downloadImage(imageUrl, title, artist);
            } else {
                btnEl.innerText = "Нет обложки";
                imgEl.style.padding = "20%"; // Чтобы иконка заглушки выглядела аккуратно
            }
        },
        onError: function(error) {
            console.log(error);
            const titleEl = cardHTML.querySelector('.track-title');
            titleEl.innerText = "Ошибка";
            titleEl.style.color = "var(--danger)";
        }
    });
}

// Глобальная функция для удаления карточки
window.removeCard = function(id) {
    const el = document.getElementById(id);
    if (el) {
        el.remove();
        updateUIState();
    }
}

function downloadImage(url, title, artist) {
    const link = document.createElement('a');
    link.href = url;
    // Очистка имени файла от запрещенных символов
    const cleanName = `${artist} - ${title}`.replace(/[/\\?%*:|"<>]/g, '-');
    link.download = `${cleanName}.jpg`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

// --- TOOLTIPS (Совместимость с вашим кодом) ---
const tooltipEl = document.getElementById('customTooltip');
function showTooltip(el) {
  if (!window.matchMedia('(hover: hover)').matches) return;
  const text = el.getAttribute('data-tip') || el.getAttribute('title'); // Поддержка title
  if (!text) return;
  
  // Если это стандартный title, убираем его чтобы браузер не показывал свой
  if (el.getAttribute('title')) {
      el.dataset.cachedTitle = text;
      el.removeAttribute('title');
  }

  const rect = el.getBoundingClientRect();
  tooltipEl.textContent = text;
  tooltipEl.classList.add('visible');
  let top = rect.bottom + 8;
  let left = rect.left + (rect.width/2) - (tooltipEl.offsetWidth/2);
  if (left < 10) left = 10;
  if (left + tooltipEl.offsetWidth > window.innerWidth) left = window.innerWidth - tooltipEl.offsetWidth - 10;
  tooltipEl.style.top = `${top}px`;
  tooltipEl.style.left = `${left}px`;
}

function hideTooltip(el) {
    tooltipEl.classList.remove('visible');
    // Возвращаем title на место
    if (el.dataset.cachedTitle) {
        el.setAttribute('title', el.dataset.cachedTitle);
    }
}

document.body.addEventListener('mouseover', (e) => {
    const target = e.target.closest('[data-tip], .close-card-btn');
    if (target) showTooltip(target);
});
document.body.addEventListener('mouseout', (e) => {
    const target = e.target.closest('[data-tip], .close-card-btn');
    if (target) hideTooltip(target);
});
</script>

<link rel="stylesheet" href="footer.css">
<div id="footer"></div>
<script>
fetch('footer.html')
  .then(r => r.text())
  .then(html => document.getElementById('footer').innerHTML = html);
</script>

<link rel="stylesheet" href="auth-widget.css">
<script type="module" src="nav-widget.js"></script> 
<script type="module" src="auth-widget.js"></script>
<script type="module" src="header.js"></script>

</body>
</html>