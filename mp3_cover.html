<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Скачать обложку из MP3</title>
<link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/3750/3750547.png">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jsmediatags/3.9.5/jsmediatags.min.js"></script>

<link rel="stylesheet" href="theme.css">

<style>
  /* === ЛОКАЛЬНЫЕ СТИЛИ (Специфика mp3) === */
  
  :root {
    --input-bg: var(--card-bg);
    --btn-hover: var(--hover-bg);
    
    --gray: #999;
    --danger: #ff5757;
  }

  body.dark {
    --input-bg: var(--card-bg); 
    --gray: #6b6b6b;
  }

  /* Инверсия иконок в темной теме (КРОМЕ СИНЕЙ КНОПКИ) */
  body.dark .theme-icon, 
  body.dark #closeBtn svg {
      filter: invert(1) brightness(1.3);
  }

  .wrap { max-width: 500px; margin: 0 auto; padding: 22px 14px 28px; }
  
  /* ШАПКА */
  .topbar {
    display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;
  }
  h1 { font-size:1.25rem; margin:0; color: var(--text); }
  
  .topbar-controls { display: flex; gap: 8px; align-items: center; }

  button.header-btn {
    background: var(--card-bg); 
    border: 1px solid var(--border); 
    border-radius: 8px; 
    color: var(--text);
    cursor: pointer; 
    transition: all 0.2s ease;
    display: flex; align-items: center; justify-content: center;
    padding: 6px 10px; height: 32px;
  }
  button.header-btn:hover { background: var(--btn-hover); }

  /* --- КАРТОЧКА --- */
  .card {
    background: var(--card-bg);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 12px;
    margin-bottom: 12px;
    box-shadow: 0 1px 2px rgba(0,0,0,.03);
    display: flex; flex-direction: column; gap: 10px;
    transition: background 0.3s ease, border-color 0.3s ease;
    position: relative; 
  }

  /* ЗОНА ЗАГРУЗКИ */
  .drop-zone {
      border: 2px dashed var(--border);
      border-radius: 12px;
      padding: 30px 20px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s ease;
      background: var(--bg); /* Чуть темнее карточки */
      display: flex; flex-direction: column; align-items: center; gap: 10px;
      position: relative;
  }
  
  .drop-zone:hover, .drop-zone.dragover {
      border-color: var(--accent);
      background: var(--btn-hover);
  }
  
  /* ОШИБКА */
  .drop-zone.error {
      border-color: var(--danger);
      background: rgba(255, 87, 87, 0.05);
  }
  .drop-zone.error:hover {
      border-color: var(--danger);
      background: rgba(255, 87, 87, 0.1); 
  }

  @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-4px); }
      75% { transform: translateX(4px); }
  }
  .shake { animation: shake 0.3s ease-in-out; }

  /* ИКОНКА ЗАГРУЗКИ */
  .drop-zone svg {
      width: 48px; height: 48px; fill: var(--accent); opacity: 0.8;
      transition: fill 0.2s;
  }
  .drop-zone.error svg { fill: var(--danger); }
  .drop-zone.error:hover svg { fill: var(--danger); }

  .drop-zone span {
      font-size: 0.95rem; color: var(--text-secondary); font-weight: 500;
  }
  .drop-zone input { display: none; }

  /* ТЕКСТ ОШИБКИ */
  .error-message {
      color: var(--danger);
      font-size: 0.9rem;
      text-align: center;
      margin-top: 0; display: none; 
  }
  .error-message.visible {
      display: block; margin-top: 5px;
      animation: fadeInErr 0.2s ease forwards;
  }
  @keyframes fadeInErr { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }

  /* РЕЗУЛЬТАТ */
  .result-container {
      width: 100%; display: flex; flex-direction: column; 
      align-items: center; gap: 10px; text-align: center; padding-top: 15px;
  }
  
  .cover-preview {
      width: 100%; max-width: 250px; aspect-ratio: 1/1;
      border-radius: 8px; object-fit: cover;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      background: #eee; display: block; 
  }
  
  .track-info { width: 100%; margin-top: 0px; }
  .track-title { font-weight: 700; font-size: 1rem; margin-bottom: 2px; color: var(--text); }
  .track-artist { color: var(--text-secondary); font-size: 0.9rem; }

  /* КНОПКА СКАЧАТЬ */
  #downloadBtn {
      padding: 8px 16px;
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--accent);
      font-size: 0.95rem; font-weight: 600;
      cursor: pointer;
      display: flex; align-items: center; justify-content: center; gap: 8px;
      transition: all 0.2s ease;
      width: 100%; max-width: 250px;
  }
  #downloadBtn:hover {
      background: var(--btn-hover);
      border-color: var(--accent);
  }
  #downloadBtn svg { width: 16px; height: 16px; fill: currentColor; }
  
  /* КНОПКА ЗАКРЫТЬ (КРЕСТИК) */
  .close-card-btn {
      position: absolute; top: 8px; right: 8px;
      background: transparent; border: none;
      cursor: pointer; color: var(--text-secondary);
      padding: 4px; line-height: 0; border-radius: 4px; 
      transition: all 0.2s; z-index: 2;
  }
  .close-card-btn:hover { color: var(--text); }
  .close-card-btn svg { width: 20px; height: 20px; fill: currentColor; }

  /* Tooltip (Глобальные стили в theme.css, но id нужен) */
  #customTooltip {
    position: fixed; background: var(--tooltip-bg); color: var(--tooltip-text); padding: 6px 12px; border-radius: 6px;
    font-size: 0.8rem; pointer-events: none; opacity: 0; transform: translateY(5px); transition: opacity 0.2s, transform 0.2s;
    z-index: 1000; box-shadow: 0 4px 12px rgba(0,0,0,0.15); white-space: nowrap; font-weight: 500;
  }
  #customTooltip.visible { opacity: 1; transform: translateY(0); }

</style>
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-384FKZ1NQP"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-384FKZ1NQP');
</script>
</head>
<body>

<script src="theme-loader.js"></script>

<div id="header-container"></div>

<div id="customTooltip"></div>

<div class="wrap">
  <div class="topbar">
      <h1>Скачать обложку из MP3</h1>
      <div class="topbar-controls">
          </div>
  </div>

  <div class="card" id="uploadCard">
    <label class="drop-zone" id="dropZone">
        <input type="file" id="fileInput" accept="audio/mpeg, audio/mp3">
        <svg viewBox="0 0 24 24"><path d="M9 16h6v-6h4l-7-7-7 7h4zm-4 2h14v2H5z"/></svg>
        <span>Нажмите или перетащите MP3 сюда</span>
    </label>
    <div id="errorMsg" class="error-message"></div>
  </div>

  <div class="card" id="resultCard" style="display:none;">
      <button id="closeBtn" class="close-card-btn" data-tip="Очистить">
          <svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
      </button>

      <div class="result-container">
          <img id="coverImg" class="cover-preview" src="" alt="Обложка">
          
          <button id="downloadBtn">
              <svg viewBox="0 0 24 24"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg>
              Скачать
          </button>

          <div class="track-info">
              <div id="trackTitle" class="track-title"></div>
              <div id="trackArtist" class="track-artist"></div>
          </div>
      </div>
  </div>

</div>

<script>
// --- ЛОГИКА MP3 ---
const fileInput = document.getElementById('fileInput');
const dropZone = document.getElementById('dropZone');
const uploadCard = document.getElementById('uploadCard');
const resultCard = document.getElementById('resultCard');
const coverImg = document.getElementById('coverImg');
const trackTitle = document.getElementById('trackTitle');
const trackArtist = document.getElementById('trackArtist');
const downloadBtn = document.getElementById('downloadBtn');
const closeBtn = document.getElementById('closeBtn');
const errorMsg = document.getElementById('errorMsg');

let currentImageUrl = null;

// Функция показа ошибки
function showError(text) {
    dropZone.classList.add('error');
    dropZone.classList.add('shake');
    errorMsg.textContent = text;
    errorMsg.classList.add('visible'); 
    
    setTimeout(() => {
        dropZone.classList.remove('shake');
    }, 300);
}

// Функция скрытия ошибки
function hideError() {
    dropZone.classList.remove('error');
    errorMsg.classList.remove('visible'); 
}

// Обработка выбора файла
fileInput.addEventListener('click', hideError); 
fileInput.addEventListener('change', (e) => {
    hideError();
    if (e.target.files.length > 0) processFile(e.target.files[0]);
});

// Drag & Drop
dropZone.addEventListener('dragover', (e) => {
    e.preventDefault();
    hideError();
    dropZone.classList.add('dragover');
});
dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
dropZone.addEventListener('drop', (e) => {
    e.preventDefault();
    dropZone.classList.remove('dragover');
    if (e.dataTransfer.files.length > 0) processFile(e.dataTransfer.files[0]);
});

function processFile(file) {
    if (!file.type.includes('audio') && !file.name.endsWith('.mp3')) {
        showError('Пожалуйста, выберите корректный MP3 файл.');
        return;
    }

    uploadCard.style.display = 'none';
    resultCard.style.display = 'flex';
    
    trackTitle.innerText = "Анализ файла...";
    trackArtist.innerText = "";
    coverImg.src = "";
    coverImg.style.display = 'none';
    downloadBtn.style.display = 'none';

    window.jsmediatags.read(file, {
        onSuccess: function(tag) {
            const tags = tag.tags;
            
            trackTitle.innerText = tags.title || file.name;
            trackArtist.innerText = tags.artist || "Неизвестный исполнитель";

            if (tags.picture) {
                const { data, format } = tags.picture;
                let base64String = "";
                for (let i = 0; i < data.length; i++) {
                    base64String += String.fromCharCode(data[i]);
                }
                currentImageUrl = `data:${format};base64,${window.btoa(base64String)}`;
                
                coverImg.src = currentImageUrl;
                coverImg.style.display = 'block';
                downloadBtn.style.display = 'flex'; 
            } else {
                coverImg.style.display = 'flex'; 
                coverImg.src = "https://cdn-icons-png.flaticon.com/512/3844/3844724.png"; 
                coverImg.style.padding = "20%";
                trackArtist.innerText += " (Обложка не найдена)";
            }
        },
        onError: function(error) {
            trackTitle.innerText = "Ошибка чтения";
            trackArtist.innerText = "Не удалось прочитать теги";
            console.log(error);
        }
    });
}

function resetUI() {
    if (currentImageUrl) {
        currentImageUrl = null;
    }
    resultCard.style.display = 'none';
    uploadCard.style.display = 'flex';
    
    fileInput.value = '';
    coverImg.style.padding = "0";
    hideError();
}

closeBtn.addEventListener('click', resetUI);

downloadBtn.addEventListener('click', () => {
    if (!currentImageUrl) return;
    const link = document.createElement('a');
    link.href = currentImageUrl;
    link.download = `cover_${Date.now()}.jpg`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
});

// --- TOOLTIPS ---
const tooltipEl = document.getElementById('customTooltip');
function showTooltip(el) {
  if (!window.matchMedia('(hover: hover)').matches) return;

  const text = el.getAttribute('data-tip');
  if (!text) return;
  const rect = el.getBoundingClientRect();
  tooltipEl.textContent = text;
  tooltipEl.classList.add('visible');
  let top = rect.bottom + 8;
  let left = rect.left + (rect.width/2) - (tooltipEl.offsetWidth/2);
  if (left < 10) left = 10;
  if (left + tooltipEl.offsetWidth > window.innerWidth) left = window.innerWidth - tooltipEl.offsetWidth - 10;
  tooltipEl.style.top = `${top}px`;
  tooltipEl.style.left = `${left}px`;
}
document.body.addEventListener('mouseover', (e) => {
    const target = e.target.closest('[data-tip]');
    if (target) showTooltip(target);
});
document.body.addEventListener('mouseout', (e) => {
    const target = e.target.closest('[data-tip]');
    if (target) tooltipEl.classList.remove('visible');
});
</script>

<link rel="stylesheet" href="footer.css">
<div id="footer"></div>
<script>
fetch('footer.html')
  .then(r => r.text())
  .then(html => document.getElementById('footer').innerHTML = html);
</script>

<link rel="stylesheet" href="auth-widget.css">
<script type="module" src="nav-widget.js"></script> 
<script type="module" src="auth-widget.js"></script>
<script type="module" src="header.js"></script>

</body>
</html>