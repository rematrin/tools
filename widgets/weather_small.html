<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        :root {
            --font-stack: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }

        body {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background-color: transparent;
            margin: 0;
            font-family: var(--font-stack);
        }

        /* === –í–ò–î–ñ–ï–¢ === */
        .ios-widget {
            position: relative;
            width: 160px;
            height: 160px;
            background: linear-gradient(180deg, #426591 0%, #779cc0 110%);
            border-radius: 24px;
            color: white;
            padding: 12px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            cursor: default;
            transition: background 0.5s ease;
        }

        .ios-widget.night-mode {
            background: linear-gradient(180deg, #182848 0%, #0a101f 100%);
        }

        /* === –í–ï–†–• === */
        .widget-top {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            flex-grow: 1;
        }

        .top-left {
            display: flex;
            flex-direction: column;
            z-index: 2;
            max-width: 100%;
            padding-left: 5px;
        }

        .city-name {
            font-size: 14px;
            font-weight: 600;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
            white-space: nowrap;
            margin-bottom: 0;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 130px;
        }

        .temperature {
            font-size: 44px;
            font-weight: 200;
            letter-spacing: -1px;
            line-height: 1;
            margin-left: -2px;
        }

        /* –ù–ò–ó (–ú–∞–ª—ã–π —Ä–µ–∂–∏–º) */
        .small-footer {
            display: flex;
            flex-direction: column;
            gap: 2px;
            margin-top: auto;
        }

        .small-row {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 13px;
            font-weight: 500;
        }

        .small-icon {
            width: 18px;
            height: 18px;
        }

        /* === –ö–ù–û–ü–ö–ò === */
        .controls {
            position: absolute;
            top: 8px;
            right: 8px;
            display: flex;
            gap: 6px;
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 10;
        }

        .ios-widget:hover .controls {
            opacity: 1;
        }

        .ctrl-btn {
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(5px);
            border: none;
            padding: 4px;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .ctrl-btn:hover {
            background: rgba(255, 255, 255, 0.4);
        }

        .ctrl-btn svg {
            width: 100%;
            height: 100%;
            fill: white;
        }

        /* === –ü–û–ò–°–ö === */
        .search-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(10px);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-top: 15px;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
            z-index: 20;
            border-radius: 24px;
        }

        .search-overlay.active {
            opacity: 1;
            pointer-events: all;
        }

        .city-input {
            width: 85%;
            padding: 8px;
            border-radius: 10px;
            border: none;
            font-size: 14px;
            outline: none;
            text-align: center;
            margin-bottom: 5px;
        }

        .suggestions-list {
            width: 85%;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 10px;
            list-style: none;
            padding: 0;
            margin: 0;
            max-height: 105px;
            overflow-y: auto;
        }

        .suggestion-item {
            padding: 8px;
            font-size: 12px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            color: #333;
        }

        .loading-layer {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.1);
            align-items: center;
            justify-content: center;
            z-index: 5;
        }

        .loading .loading-layer {
            display: flex;
        }
    </style>
</head>

<body>

    <div class="ios-widget" id="widget">

        <div class="search-overlay" id="searchOverlay">
            <input type="text" class="city-input" id="cityInput" placeholder="–ì–æ—Ä–æ–¥ –∏–ª–∏ –∏–Ω–¥–µ–∫—Å..." autocomplete="off">
            <ul class="suggestions-list" id="suggestionsList"></ul>
        </div>
        <div class="loading-layer"></div>

        <div class="controls">
            <button class="ctrl-btn" onclick="toggleSearch()" title="–ü–æ–∏—Å–∫">
                <svg viewBox="0 0 24 24">
                    <path
                        d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z" />
                </svg>
            </button>
        </div>

        <div class="widget-top">
            <div class="top-left">
                <div class="city-name" id="uiCity">...</div>
                <div class="temperature" id="uiTemp">--¬∞</div>
            </div>
        </div>

        <div class="small-footer">
            <div class="small-row">
                <div id="uiSmallIcon" class="small-icon"></div>
                <span id="uiSmallDesc">--</span>
            </div>
            <div class="small-row" style="opacity: 0.8">
                <span id="uiSmallHL">H:--¬∞ L:--¬∞</span>
            </div>
        </div>
    </div>

    <script>
        const els = {
            widget: document.getElementById('widget'),
            overlay: document.getElementById('searchOverlay'),
            input: document.getElementById('cityInput'),
            list: document.getElementById('suggestionsList'),
            city: document.getElementById('uiCity'),
            temp: document.getElementById('uiTemp'),
            smallIcon: document.getElementById('uiSmallIcon'),
            smallDesc: document.getElementById('uiSmallDesc'),
            smallHL: document.getElementById('uiSmallHL')
        };

        let debounceTimer;

        // === –í–°–¢–†–û–ï–ù–ù–´–ï –ò–ö–û–ù–ö–ò (SVG) ===
        const icons = {
            clearDay: `<svg viewBox="0 0 64 64" fill="none"><circle cx="32" cy="32" r="14" fill="#FFCC00"/><path d="M32 6V12M32 52V58M58 32H52M12 32H6M50.38 13.62L46.14 17.86M17.86 46.14L13.62 50.38M50.38 50.38L46.14 46.14M17.86 17.86L13.62 13.62" stroke="#FFCC00" stroke-width="4" stroke-linecap="round"/></svg>`,
            clearNight: `<svg viewBox="0 0 64 64" fill="none"><path d="M27.5 48C17.84 48 10 40.16 10 30.5C10 22.1 15.8 15.3 23.4 13.5C22.5 15.4 22 17.6 22 20C22 29.94 30.06 38 40 38C42.4 38 44.6 37.5 46.5 36.6C44.7 43.2 36.9 48 27.5 48Z" fill="#F0F0F0"/></svg>`,
            partlyCloudyDay: `<svg viewBox="0 0 64 64" fill="none"><circle cx="40" cy="24" r="8" fill="#FFCC00"/><path d="M40 12V14M40 34V36M52 24H50M30 24H28M48.48 15.52L47.06 16.94M32.94 31.06L31.52 32.48M48.48 32.48L47.06 31.06M32.94 16.94L31.52 15.52" stroke="#FFCC00" stroke-width="2" stroke-linecap="round"/><path d="M44 44C44 48.4 40.4 52 36 52H20C15.6 52 12 48.4 12 44C12 39.8 15.2 36.4 19.3 36.1C20.4 31.4 24.6 28 29.5 28C35.8 28 41 33.2 41 39.5" fill="#FFFFFF"/></svg>`,
            cloudy: `<svg viewBox="0 0 64 64" fill="none"><path d="M48 44C48 48.4 44.4 52 40 52H20C15.6 52 12 48.4 12 44C12 39.8 15.2 36.4 19.3 36.1C20.4 31.4 24.6 28 29.5 28C35.8 28 41 33.2 41 39.5C41 39.7 41 39.8 40.9 40C45 40.3 48 43.8 48 48" fill="#FFFFFF"/></svg>`,
            fog: `<svg viewBox="0 0 64 64" fill="none"><path d="M14 26H50M10 36H54M16 46H48" stroke="#FFFFFF" stroke-width="4" stroke-linecap="round" opacity="0.8"/></svg>`,
            rain: `<svg viewBox="0 0 64 64" fill="none"><path d="M44 38C44 42.4 40.4 46 36 46H20C15.6 46 12 42.4 12 38C12 33.8 15.2 30.4 19.3 30.1C20.4 25.4 24.6 22 29.5 22C35.8 22 41 27.2 41 33.5" fill="#FFFFFF"/><path d="M22 50L20 56M32 50L30 56M42 50L40 56" stroke="#87CEEB" stroke-width="3" stroke-linecap="round"/></svg>`,
            snow: `<svg viewBox="0 0 64 64" fill="none"><path d="M44 38C44 42.4 40.4 46 36 46H20C15.6 46 12 42.4 12 38C12 33.8 15.2 30.4 19.3 30.1C20.4 25.4 24.6 22 29.5 22C35.8 22 41 27.2 41 33.5" fill="#FFFFFF"/><circle cx="22" cy="54" r="2" fill="#FFFFFF"/><circle cx="32" cy="54" r="2" fill="#FFFFFF"/><circle cx="42" cy="54" r="2" fill="#FFFFFF"/></svg>`,
            thunder: `<svg viewBox="0 0 64 64" fill="none"><path d="M44 38C44 42.4 40.4 46 36 46H20C15.6 46 12 42.4 12 38C12 33.8 15.2 30.4 19.3 30.1C20.4 25.4 24.6 22 29.5 22C35.8 22 41 27.2 41 33.5" fill="#FFFFFF"/><path d="M28 46L22 56H30L26 64" stroke="#FFCC00" stroke-width="3" stroke-linejoin="round"/></svg>`
        };

        window.addEventListener('DOMContentLoaded', () => {
            const savedCity = localStorage.getItem('mw_city');
            const savedLat = localStorage.getItem('mw_lat');
            const savedLon = localStorage.getItem('mw_lon');

            if (savedCity && savedLat) updateWidget(savedLat, savedLon, savedCity);
            else updateWidget(50.07, 14.43, "Prague");
        });

        function toggleSearch() {
            els.overlay.classList.toggle('active');
            if (els.overlay.classList.contains('active')) {
                els.input.value = ''; els.list.innerHTML = ''; els.input.focus();
            }
        }
        els.overlay.addEventListener('click', (e) => { if (e.target === els.overlay) toggleSearch(); });

        els.input.addEventListener('input', (e) => {
            const q = e.target.value.trim();
            clearTimeout(debounceTimer);
            if (q.length < 2) return;
            debounceTimer = setTimeout(() => fetchSuggestions(q), 400);
        });

        async function fetchSuggestions(query) {
            const isZip = /^\d/.test(query);
            let results = [];
            try {
                if (isZip) {
                    const res = await fetch(`https://nominatim.openstreetmap.org/search?q=${query}&format=json&addressdetails=1&limit=5&accept-language=ru`);
                    const data = await res.json();
                    results = data.map(i => {
                        const addr = i.address;
                        const cityName = addr.city || addr.town || addr.village || addr.suburb || i.display_name.split(',')[0];
                        const region = addr.state || addr.country;
                        return { name: cityName, display: `üìÆ ${query} - ${cityName}, ${region}`, lat: i.lat, lon: i.lon };
                    });
                } else {
                    const makeRequest = async (q) => {
                        const r = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(q)}&count=10&language=ru&format=json`);
                        return await r.json();
                    };
                    let data = await makeRequest(query);
                    if (!data.results) {
                        let fixQuery = null;
                        if (query.includes(' ')) fixQuery = query.replace(/ /g, '-');
                        else if (query.includes('-')) fixQuery = query.replace(/-/g, ' ');
                        if (fixQuery) data = await makeRequest(fixQuery);
                    }
                    if (data.results) {
                        const seen = new Set();
                        results = data.results.filter(item => {
                            const key = `${item.name}-${item.admin1 || ''}-${item.country_code}`;
                            if (seen.has(key)) return false;
                            seen.add(key);
                            return true;
                        }).slice(0, 5)
                            .map(c => ({
                                name: c.name, display: `${c.name}, ${c.country_code}`, lat: c.latitude, lon: c.longitude
                            }));
                    }
                }
                els.list.innerHTML = '';
                if (results.length > 0) {
                    results.forEach(item => {
                        const li = document.createElement('li');
                        li.className = 'suggestion-item';
                        li.innerText = item.display || item.name;
                        li.onclick = () => {
                            localStorage.setItem('mw_city', item.name);
                            localStorage.setItem('mw_lat', item.lat);
                            localStorage.setItem('mw_lon', item.lon);
                            updateWidget(item.lat, item.lon, item.name);
                            toggleSearch();
                        };
                        els.list.appendChild(li);
                    });
                }
            } catch (e) { }
        }

        async function updateWidget(lat, lon, cityName) {
            els.widget.classList.add('loading');
            els.city.innerText = cityName;
            try {
                const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,weather_code,is_day&daily=temperature_2m_max,temperature_2m_min,sunrise,sunset&timezone=auto`;
                const res = await fetch(url);
                const data = await res.json();
                const curr = data.current;
                const daily = data.daily;

                const timeZone = data.timezone;
                const localDate = new Date(new Date().toLocaleString("en-US", { timeZone: timeZone }));
                const localHour = localDate.getHours();
                const sunriseHour = new Date(daily.sunrise[0]).getHours();
                const sunsetHour = new Date(daily.sunset[0]).getHours();
                const isNightNow = (localHour > sunsetHour || localHour < sunriseHour);

                if (isNightNow) els.widget.classList.add('night-mode');
                else els.widget.classList.remove('night-mode');

                const weatherIconHtml = getIconHtml(curr.weather_code, !!curr.is_day);
                const weatherText = getWeatherText(curr.weather_code);
                const hlStr = `H:${Math.round(daily.temperature_2m_max[0])}¬∞ L:${Math.round(daily.temperature_2m_min[0])}¬∞`;

                els.temp.innerText = Math.round(curr.temperature_2m) + "¬∞";
                els.smallIcon.innerHTML = weatherIconHtml;
                els.smallDesc.innerText = weatherText;
                els.smallHL.innerText = hlStr;
            } catch (e) { console.error(e); }
            finally { els.widget.classList.remove('loading'); }
        }

        function getIconHtml(code, isDay) {
            if (code === 0) return isDay ? icons.clearDay : icons.clearNight;
            if (code === 1 || code === 2) return isDay ? icons.partlyCloudyDay : icons.cloudy;
            if (code === 3) return icons.cloudy;
            if (code === 45 || code === 48) return icons.fog;
            if (code >= 51 && code <= 67) return icons.rain;
            if (code >= 80 && code <= 82) return icons.rain;
            if (code >= 71 && code <= 77) return icons.snow;
            if (code >= 85 && code <= 86) return icons.snow;
            if (code >= 95) return icons.thunder;
            return icons.cloudy;
        }

        function getWeatherText(code) {
            const map = {
                0: "–Ø—Å–Ω–æ", 1: "–ü—Ä–µ–∏–º. —è—Å–Ω–æ", 2: "–û–±–ª–∞—á–Ω–æ", 3: "–ü–∞—Å–º—É—Ä–Ω–æ",
                45: "–¢—É–º–∞–Ω", 48: "–ò–∑–º–æ—Ä–æ–∑—å",
                51: "–ú–æ—Ä–æ—Å—å", 53: "–ú–æ—Ä–æ—Å—å", 55: "–ú–æ—Ä–æ—Å—å",
                61: "–î–æ–∂–¥—å", 63: "–î–æ–∂–¥—å", 65: "–õ–∏–≤–µ–Ω—å",
                71: "–°–Ω–µ–≥", 73: "–°–Ω–µ–≥", 75: "–°–Ω–µ–≥–æ–ø–∞–¥",
                77: "–ì—Ä–∞–¥",
                80: "–õ–∏–≤–µ–Ω—å", 81: "–õ–∏–≤–µ–Ω—å", 82: "–õ–∏–≤–µ–Ω—å",
                95: "–ì—Ä–æ–∑–∞", 96: "–ì—Ä–æ–∑–∞", 99: "–ì—Ä–æ–∑–∞"
            };
            return map[code] || "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ";
        }
    </script>
</body>

</html>